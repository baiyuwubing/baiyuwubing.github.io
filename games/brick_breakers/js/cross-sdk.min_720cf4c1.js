'use strict';let consts={Version:'0.2.1',NetUrl:{Test:'https://platform-test.hortorgames.com',Prod:'https://platform.hortorgames.com'},Box:{appId:'wx3301a6cbd35d9935',path:'/pages/index/index',envVersion:'release',extraData:{}},Requests:{FetchAds:'/cross/api/v1/new_fetch',ImagePath:'/cross/api/v1/show',Log:'/cross/api/v1/log'},Errors:{NetWorkErr:{errCode:1e3,errMsg:'\u7F51\u7EDC\u9519\u8BEF'},AdsDataErr:{errCode:1001,errMsg:'\u6CA1\u6709\u5E7F\u544A\u6570\u636E'},CantUseNavFun:{errCode:0,errMsg:'\u65E0\u6CD5\u4F7F\u7528\u65B9\u6CD5\u8DF3\u8F6C\u5C0F\u7A0B\u5E8F'}},LogType:{ClickAd:1,ShowAd:2}};class Util{static assign(c,a){if(Object.assign)return Object.assign(c,a);for(let b in a)c[b]=a[b];return c}static jsonToQuery(a,b){if(!a)return'';let c=[];for(let d in a){let e=b?encodeURIComponent(a[d]):a[d];c.push(`${d}=${e}`)}return c.join('&')}static queryToJson(a){let b={};if(!a)return b;let c=decodeURIComponent(a),d=c.split('&');for(let c in d){let a=d[c].split('=');b[a[0]]=a[1]}return b}static getSystemInfo(){return this.systemInfo?this.systemInfo:(this.systemInfo=wx.getSystemInfoSync(),this.systemInfo.crossSDKV=consts.Version,this.systemInfo)}static getSystemInfoStr(){if(this.systemInfoStr)return this.systemInfoStr;let a=this.sliceJson(this.getSystemInfo(),['SDKVersion','brand','model','system','version','crossSDKV']);return this.systemInfoStr=JSON.stringify(a),this.systemInfoStr}static sliceJson(a,b){if(!a||!b)return{};'string'==typeof b&&(b=b.replace(/\s+/g,'').split(','));let c={};return b.map((b)=>{c[b]=a[b]}),c}static isFun(a){return a&&'function'==typeof a}static promisify(a){return function(b={}){return new Promise((c,d)=>{b.success=function(a){c(a)},b.fail=function(a){d(a)},a(b)})}}static setStorage(a,b,c){let d=c?`_${c}`:'',e=`_CSDK_${a}${d}`;e&&'undefined'!=typeof b&&wx.setStorageSync(e,b)}static getStorage(a,b){let c=b?`_${b}`:'',d=`_CSDK_${a}${c}`;return d?wx.getStorageSync(d):''}static clearStorage(a){wx.removeStorageSync(consts.StorageKeys[a])}}class NetWork{constructor(a){this.HOST=consts.NetUrl[a.env]}request(a,b,c,d){if(!a||!b)return!1;let{success:e,fail:f,complete:g,params:h}=c||{};h.sysInfo=Util.getSystemInfoStr();let i={"content-type":d?'application/json':'application/x-www-form-urlencoded'},j=(a)=>{let b={errMsg:a.errMsg||a||'',errCode:a.errCode||consts.Errors.NetWorkErr.errCode};Util.isFun(f)&&f(b)};return wx.request({url:b,data:h,method:a,header:i,success:(a)=>{let b=a.data;return 200==a.statusCode?b.meta&&0!=b.meta.errCode?j(b.meta):void(Util.isFun(e)&&e(b.data)):j(b)},complete:(a)=>{Util.isFun(g)&&g(a)},fail:j})}get(a,b){return this.request('GET',a,b)}post(a,b){return this.request('POST',a,b)}getJSON(a,b){return this.request('GET',a,b,!0)}postJSON(a,b){return this.request('POST',a,b,!0)}}class AppBridge{constructor(a){this.conf=a,this.network=new NetWork(a),this.defData={},this.change='',this.ads='',this.nowAd='',this.lastIndex='',this.showing=!1,this.isMiniGame='undefined'!=typeof GameGlobal&&'undefined'==typeof App,console.log('[CSDK] isMiniGame',this.isMiniGame),this.canUseNavigator=wx.canIUse&&wx.canIUse('navigateToMiniProgram')}postLog(a=consts.LogType.ShowAd,b){let c=Util.assign({prId:b.prId||'',logType:a},this.conf);this.network.post(this.network.HOST+consts.Requests.Log,{params:c})}_goApp(a,b={}){if(!this.canUseNavigator){let a=consts.Errors.CantUseNavFun;return b.complete(a),b.success(a),!1}let{appId:c,path:d,envVersion:e,extraData:f}=a,g=Util.assign(b,{appId:c,path:d,envVersion:e,extraData:f});console.log('[CSDK] goApp',g),wx.navigateToMiniProgram(g)}_previewImage(a,b={}){let{adsId:c,gameId:d,openId:e}=this.params,f=new Date().getTime(),g=Util.jsonToQuery({fromGameId:d,toGameId:a.gameId,adsId:c,openId:e,t:f}),h=`${a.url}?${g}`;console.log('[CSDK] preview ad ',h);let i=Util.assign(b,{urls:[h]});wx.previewImage(i)}_goGame(...a){this.isMiniGame?this._previewImage(...a):this._goApp(...a)}_setAds(a){a.map((a)=>{a=Util.assign(a,consts.Box),a.path=`${consts.Box.path}?f=${this.conf.gameId}&t=${a.gameId||''}&prId=${a.prId||''}`}),this.ads=a}_getAds(){return this.ads||[]}_setData(a){this._setAds(a.ads),delete a.Title,delete a.ads,this.defData=Util.assign(a,consts.Box),this.defData.path=`${consts.Box.path}?f=${this.conf.gameId}`}_getData(a=this.nowAd){return a.icon?a:this.defData}_removeAd(){let a=this._getAds();a.shift(),this.ads=a}reset(){let a=this._getAds(),b=a[0];return b?void(this.nowAd=b,this.postLog(consts.LogType.ShowAd,b),this._removeAd(),this.change&&this.change(this._getData(b))):this._loadData(()=>{console.log('reload data success')},(a)=>{this.nowAd='',console.log('no data anymore',a)})}onChange(a){Util.isFun(a)&&(this.change=a)}show(a={}){if(this.showing)return!1;if(this.showing=!0,!this.nowAd)return console.log('[CSDK] no ad');let b=this.nowAd;this.postLog(consts.LogType.ClickAd,b);let{success:c,fail:d,complete:e}=a;this._goGame(b,{success:(a)=>{console.log('[CSDK] show success',a),Util.isFun(c)&&c(a)},fail:(a)=>{console.log('[CSDK] show fail',a),Util.isFun(d)&&d(a)},complete:(a)=>{setTimeout(()=>{this.showing=!1,this.reset(),Util.isFun(e)&&e(a)},300)}})}_loadData(a,b){let c=this.params,d=(a)=>{Util.isFun(b)&&b(a),console.log('[CSDK] create fail',a)};this.network.post(`${this.network.HOST}${consts.Requests.FetchAds}`,{params:c,success:(b)=>{if(!b.ads||!b.ads.length)return d(consts.Errors.AdsDataErr);this._setData(b);let c=this._getData();console.log('[CSDK] create success',c),Util.isFun(a)&&a(c),this.reset()},fail:d})}create(a){console.log('[CSDK] create',a.adsId);let{adsId:b,success:c,fail:d}=a,{gameId:e,openId:f}=this.conf;this.adsId=b,this.params={gameId:e,openId:f,adsId:b},this._loadData(c,d)}static getInstance(a){return this.instance=this.instance||new AppBridge(a),this.instance}}let CrossSDK={ads:{},createAd(a){if(!a||!a.adsId)return console.warn('[CSDK] no adsId');if(this.ads[a.adsId])return this.ads[a.adsId];let b=new AppBridge(this.conf);return b.create(a),this.ads[a.adsId]=b,b},showAd(a){'string'==typeof a&&(a={adsId:a});let{adsId:b}=a;if(!b)return console.warn('[CSDK] no adsId');let c=this.ads[b];return c?void c.show(a):console.warn('[CSDK] no ad')},init(a){this.conf=a}};'undefined'==typeof App?'undefined'==typeof module?'undefined'!=typeof window&&(window.crossSDK=CrossSDK):module.exports=CrossSDK:function(a){function b(){this.crossSDK=new d(this)}let c=function(a,b,c){if(a[b]){let d=a[b];a[b]=function(a){c.call(this,a,b),d.call(this,a)}}else a[b]=function(a){c.call(this,a,b)}},d=function(a){this.app=a};d.prototype=a;let e=App;App=(a)=>{c(a,'onLaunch',b),e(a)}}(CrossSDK);