var __reflect=this&&this.__reflect||function(e,t,i){e.__class__=t,i?i.push(t):i=[t],e.__types__=e.__types__?i.concat(e.__types__):i},__extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);i.prototype=t.prototype,e.prototype=new i},__awaiter=this&&this.__awaiter||function(e,t,i,o){return new(i||(i=Promise))(function(n,s){function a(e){try{h(o.next(e))}catch(t){s(t)}}function r(e){try{h(o["throw"](e))}catch(t){s(t)}}function h(e){e.done?n(e.value):new i(function(t){t(e.value)}).then(a,r)}h((o=o.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function i(e){return function(t){return o([e,t])}}function o(i){if(n)throw new TypeError("Generator is already executing.");for(;h;)try{if(n=1,s&&(a=s[2&i[0]?"return":i[0]?"throw":"next"])&&!(a=a.call(s,i[1])).done)return a;switch(s=0,a&&(i=[0,a.value]),i[0]){case 0:case 1:a=i;break;case 4:return h.label++,{value:i[1],done:!1};case 5:h.label++,s=i[1],i=[0];continue;case 7:i=h.ops.pop(),h.trys.pop();continue;default:if(a=h.trys,!(a=a.length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){h=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){h.label=i[1];break}if(6===i[0]&&h.label<a[1]){h.label=a[1],a=i;break}if(a&&h.label<a[2]){h.label=a[2],h.ops.push(i);break}a[2]&&h.ops.pop(),h.trys.pop();continue}i=t.call(e,h)}catch(o){i=[6,o],s=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var n,s,a,r,h={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return r={next:i(0),"throw":i(1),"return":i(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r},BaseView=function(e){function t(){var t=e.call(this)||this;return t._needBlackBg=!0,t._needShowEffect=!0,t}return __extends(t,e),t.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},t.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.percentWidth=this.percentHeight=100,this.drawBlackBg()},t.prototype.drawBlackBg=function(){if(this._needBlackBg){var e=2*this.stage.stageWidth,t=2*this.stage.stageHeight;this._bgShape||(this._bgShape=new egret.Shape,this._bgShape.graphics.beginFill(0,.5),this._bgShape.graphics.drawRect(0,0,e,t),this._bgShape.graphics.endFill()),this._bgShape.x=(this.width-e)/2,this._bgShape.y=(this.height-t)/2,this.addChildAt(this._bgShape,0)}else func.removeFromParent(this._bgShape)},t.prototype.isShow=function(){return this.visible},t.prototype.show=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.visible=!0;var i=this.parent||this._parent;i&&(i.addChild(this),egret.Tween.removeTweens(this),this._needShowEffect&&(this.alpha=.2,this.scaleX=this.scaleY=.9,egret.Tween.get(this).to({alpha:1}),egret.Tween.get(this).to({scaleX:1,scaleY:1},500,egret.Ease.backInOut)))},t.prototype.hide=function(){for(var e=this,t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];egret.Tween.removeTweens(this),egret.Tween.get(this).to({alpha:0,scaleX:.8,scaleY:.8},500).call(function(){e.visible=!1,e._parent=e.parent,func.removeFromParent(e)})},t.prototype.addTouchTapEvent=function(e,t,i,o){e.addEventListener(egret.TouchEvent.TOUCH_TAP,t,this,i,o)},t.prototype.hideBgShape=function(){this._bgShape&&(this._bgShape.visible=!1)},t.prototype.showBgShape=function(){this._bgShape&&(this._bgShape.visible=!0)},t.prototype.setParent=function(e){this._parent=e},t}(eui.Component);__reflect(BaseView.prototype,"BaseView",["eui.UIComponent","egret.DisplayObject"]);var SingletonClass=function(){function e(){}return e.ins=function(){return this._ins||(this._ins=new this),this._ins},e}();__reflect(SingletonClass.prototype,"SingletonClass");var EffectMgr=function(e){function t(){var t=e.call(this)||this;return t._effectReses={},t._effectFactory={},t}return __extends(t,e),t.ins=function(){return e.ins.call(this)},t.prototype.init=function(){this._effectReses={};for(var e=0,i=[t.RES_EFFECT_DEL,t.RES_EFFECT_DEL_LIGHT,t.RES_EFFECT_PERFECT];e<i.length;e++){var o=i[e];this._effectReses[o]=this.newMovieClip(o)}},t.prototype.getMovieClip=function(e){return this._effectReses[e]||(this._effectReses[e]=this.newMovieClip(e)),this._effectReses[e]},t.prototype.newMovieClip=function(e){if(!this._effectFactory[e]){var t=RES.getRes(e+"_json"),i=RES.getRes(e+"_png");this._effectFactory[e]=new egret.MovieClipDataFactory(t,i)}var o=this._effectFactory[e],n=new egret.MovieClip(o.generateMovieClipData(e));return n.addEventListener(egret.Event.COMPLETE,function(e){func.removeFromParent(n)},this),n.touchEnabled=!1,n},t.RES_EFFECT_DEL="effect_del",t.RES_EFFECT_DEL_LIGHT="effect_del_light",t.RES_EFFECT_PERFECT="effect_perfect",t.RES_EFFECT_CLEAR="effect_clear",t.RES_EFFECT_CLICK="effect_click",t.RES_EFFECT_GUIDE_DROP="effect_guide_drop",t}(SingletonClass);__reflect(EffectMgr.prototype,"EffectMgr");var DebugPlatform=function(){function e(){}return e.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,new Promise(function(e,t){if(isSdk){for(;"undefined"==typeof Bigbear;);Bigbear.init(function(t){console.log("sdk init success"),console.log(t),GameConst.randomSeed=t.randoms||GameConst.randomSeed,GameConst.bestAllTimeScore=t.best_score||0,GameConst.bestTodayScore=t.today_best_score||0,GameConst.gametype=t.game_type||GameConst.gametype,MarkDataUtil._player_id=t.player_id||-1,GameConst.isFirstGame=1==GameConst.gametype&&(t.cash_count||0)+(t.chip_count||0)<=0,GuideMgr.ins().guideType=GameConst.isFirstGame?1:0,e()},GameConst.appVersion)}else GuideMgr.ins().guideType=1,GameConst.bestTodayScore=0,GameConst.bestAllTimeScore=LocalStorageMgr.ins().getLocal(LocalStorageMgr.KEY_bestAllTimeScore,0),GameConst.randomSeed=Math.round(1e3+8999*Math.random()).toString(),e()})]})})},e.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2]})})},e}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform),window.isSdk||(window.isSdk=isSdk);var ThemeAdapter=function(){function e(){}return e.prototype.getTheme=function(e,t,i,o){function n(e){t.call(o,e)}function s(t){t.resItem.url==e&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,s,null),i.call(o))}"undefined"!=typeof generateEUI?egret.callLater(function(){t.call(o,generateEUI)},this):(RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,s,null),RES.getResByUrl(e,n,this,RES.ResourceItem.TYPE_TEXT))},e}();__reflect(ThemeAdapter.prototype,"ThemeAdapter",["eui.IThemeAdapter"]);var AssetAdapter=function(){function e(){}return e.prototype.getAsset=function(e,t,i){function o(o){t.call(i,o,e)}if(RES.hasRes(e)){var n=RES.getRes(e);n?o(n):RES.getResAsync(e,o,this)}else RES.getResByUrl(e,o,this,RES.ResourceItem.TYPE_IMAGE)},e}();__reflect(AssetAdapter.prototype,"AssetAdapter",["eui.IAssetAdapter"]);var func;!function(e){function t(e){e&&e.parent&&e.parent.removeChild(e)}function i(e,t,i,o,n){void 0===n&&(n=egret.HttpMethod.GET);var s=new egret.HttpRequest;s.responseType=egret.HttpResponseType.TEXT;var a="",r=!0;for(var h in t)r?r=!1:a+="&",a+=h+"="+t[h];s.open(n==egret.HttpMethod.GET?e+"?"+a:e,n),s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n==egret.HttpMethod.GET?s.send():s.send(a),egret.log("sendUrl:"+e+"  \nsendParams:"+a),s.addEventListener(egret.Event.COMPLETE,function(e){var t=e.currentTarget;if(t&&t.response){var n=JSON.parse(t.response);egret.log("request.response:"+t.response);var s=n.error_code,a=n.error||"ERROR";n&&0==s?i(n):o(s,a)}else o(-2,"NO_REQUEST")},this),s.addEventListener(egret.IOErrorEvent.IO_ERROR,function(){o(-1,"IO_ERROR")},this)}function o(e,t,i){void 0===t&&(t=function(){}),e.anchorOffsetX=e.width/2,e.anchorOffsetY=e.height/2,e.x+=e.width/2,e.y+=e.height/2,e.anchorOffsetY=e.height/2;var o=i?i:e;e.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){egret.Tween.get(e).to({scaleX:.85,scaleY:.85},100)},o),e.addEventListener(egret.TouchEvent.TOUCH_CANCEL,function(){egret.Tween.get(e).to({scaleX:1,scaleY:1},100)},o),e.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,function(){egret.Tween.get(e).to({scaleX:1,scaleY:1},100)},o),e.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){egret.Tween.get(e).to({scaleX:1,scaleY:1},100),t&&t.call(o)},o)}function n(e){var t=e,i=window.screen.width/window.screen.height,o=egret.StageScaleMode.SHOW_ALL;egret.Capabilities.isMobile&&(egret.log("windowRatio=======?",i),o=egret.StageScaleMode.FIXED_WIDTH,(.56>i||i>.6)&&(o=egret.StageScaleMode.SHOW_ALL)),t.stage.scaleMode=o}function s(e,t){return(t.y-e.y)/(t.x-e.x)}function a(e){return e.length<=0?e:e.substring(0,1).toUpperCase()+e.substring(1)}e.removeFromParent=t,e.sendHttpRequest=i,e.addButtonClickByEff=o,e.screenAdaptation=n,e.getPonitSlope=s,e.firstUpperCase=a}(func||(func={}));var MarkEventId;!function(e){e[e.HEARTTIME=100401]="HEARTTIME",e[e.BEGIN_GAME=100402]="BEGIN_GAME",e[e.SUBMIT_SCORE=100403]="SUBMIT_SCORE",e[e.END_GAME=100404]="END_GAME",e[e.ELIMINATE=100405]="ELIMINATE",e[e.HOLD_BOX=100406]="HOLD_BOX",e[e.LEVEL_UP=100407]="LEVEL_UP",e[e.CLEAN_MESS=100408]="CLEAN_MESS",e[e.COMBO=100409]="COMBO",e[e.HOLD_FIRST=100410]="HOLD_FIRST"}(MarkEventId||(MarkEventId={}));var MarkDataUtil={_gameTime:-1,_gameScore:-1,_player_id:-1,catchMarkData:[],markSendCount:0,_timeId:0,markGameActionData:function(e,t,i){void 0===i&&(i=!1),t.os_time=(new Date).getTime(),t.guide=GuideMgr.ins().guideType,t.game_time=MarkDataUtil._gameTime,this.catchMarkData.push({event_id:e,mark_data:t}),i&&this.maidianNow()},maidianNow:function(){isSdk&&"undefined"!=typeof Bigbear&&this.catchMarkData.length>0&&(this.markSendCount++,Bigbear.maidian("tetris_"+this._player_id+"_"+this.markSendCount+"_"+GameConst.appVersion,JSON.stringify(this.catchMarkData)),this.catchMarkData=[])},markGameDateByHeart:function(e){var t=this,i=MarkEventId.HEARTTIME;if(e){if(this._timeId)return;this._timeId=setInterval(function(){var e={desc:"tetris heart",os_time:(new Date).getTime(),game_time:t._gameTime,game_score:t._gameScore};GuideMgr.ins().hasGuide()||t.markGameActionData(i,e,!0)},1e4)}else this._timeId&&clearInterval(this._timeId),this._timeId=0,this.maidianNow()},updateData:function(e,t){this._gameTime=e,this._gameScore=t}},Main=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.createChildren=function(){var i=this;e.prototype.createChildren.call(this),null==t.ins&&(t.ins=this),egret.lifecycle.addLifecycleListener(function(e){}),egret.lifecycle.onPause=function(){egret.ticker.pause(),i.mainView&&t.ins.mainView.getView(GameView).pauseGame(!0)},egret.lifecycle.onResume=function(){egret.ticker.resume()};var o=new AssetAdapter;egret.registerImplementation("eui.IAssetAdapter",o),egret.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.runGame()["catch"](function(e){egret.error(e)})},t.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.loadResource()];case 1:return e.sent(),[4,platform.getUserInfo()];case 2:return e.sent(),this.createGameScene(),[4,RES.getResAsync("description_json")];case 3:return e.sent(),[2]}})})},t.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var e,t;return __generator(this,function(i){switch(i.label){case 0:return i.trys.push([0,5,,6]),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return i.sent(),[4,RES.loadGroup("load",0)];case 2:return i.sent(),[4,this.loadTheme()];case 3:return i.sent(),e=new LoadingUI,this.stage.addChild(e),[4,RES.loadGroup("preload",1,e)];case 4:return i.sent(),this.stage.removeChild(e),[3,6];case 5:return t=i.sent(),console.error(t),[3,6];case 6:return[2]}})})},t.prototype.loadTheme=function(){var e=this;return new Promise(function(t,i){var o=new eui.Theme("resource/default.thm.json",e.stage);o.addEventListener(eui.UIEvent.COMPLETE,function(){t()},e)})},t.prototype.createGameScene=function(){isSdk&&Bigbear.sucess_enter_game_inform(),RandomMgr.ins().init(),SoundMgr.ins().init(),EffectMgr.ins().init(),this.mainView=new MainView,this.stage.addChild(this.mainView),GameManager.ins().init(),GameModel.ins().init(),GameWorld.getInstance().startGame(),GameManager.ins().resetGame()},t.createBitmapByName=function(e){var t=new egret.Bitmap,i=RES.getRes(e);return t.texture=i,t},t}(eui.UILayer);__reflect(Main.prototype,"Main");var GameConst=function(){function e(){}return e.appVersion="0.18062901",e.UP="up",e.DOWN="down",e.LEFT="left",e.RIGHT="right",e.isFirstGame=!0,e.gametype=1,e.randomSeed="fE794D0C28B53A61",e.bestTodayScore=3e3,e.bestAllTimeScore=7e3,e.gameTotalTime=240,e.initMessLines=4,e.initRemindMessLines=4,e.initMessBrokenMaxNum=3,e.initMessBrokenMinNum=1,e.newMessBrokenMaxNum=3,e.newMessBrokenMinNum=1,e.totalEliminateLines_2_gameLevel=[5,10,20,30,40,50,60,70],e.GAME_LEVEL_SPEED=[1,1.5,2,3,4.5,6,8,11,15,15,15,15,15,15,15],e.ONE_TIME_ELIMINATION_SCORE=[0,100,300,600,1200],e.GAME_LEVEL_SCORE_Multiple=[1,1,1,1,1,1,1,1,2.5,2.5,2.5,2.5,2.5,2.5,2.5],e.BOX_COLOR_LANDED_SCORE=[0,15,15,15,15,15,15,15,15],e.MESS_CLEAN_SCORE=5e3,e.MAX_MISS_COUNT=5,e.MAP_COL=10,e.MAP_ROW=21,e.BOX_WIDTH=39,e.BOX_HEIGHT=39,e.BOX_INIT_X=5,e.BOX_INIT_Y=1,e.ACCELERATED_DOWN_MULTIPLE=15,e.H_MOVE_A_CELL_PIXELS=55,e.DOWN_MOVE_ACCELERATED_DOWN_PIXELS=50,e.DIRECTLY_DOWN_PIXELS=40,e.DIRECTLY_DOWN_INTERVAL=200,e.V_MOVE_INIT_INTERVAL=60,e.NO_BOX_LIGHT_EFFECT=0,e.MESS_BOX_COLOR=8,e}();__reflect(GameConst.prototype,"GameConst");var GameManager=function(){function e(){this._mapInfo=[],this._holdBoxInfo=[],this._nowBoxInfo=[],this._nextBoxInfo=[],this._speed=50,this._interval=0,this._moveState=GameConst.DOWN,this._isGameOver=!1,this._isGamePause=!1,this._pointBox=new egret.Point(GameConst.BOX_INIT_X,GameConst.BOX_INIT_Y),this._optionTime=egret.getTimer(),this._directlyDowning=!1,this._lastBoxMoveDownTime=egret.getTimer(),this._isBoxDowned=!1,this._createdNextBox=!0}return e.ins=function(){return e.instance||(e.instance=new e),e.instance},Object.defineProperty(e.prototype,"pointBox",{get:function(){return this._pointBox},set:function(e){this._pointBox=e},enumerable:!0,configurable:!0}),e.prototype.init=function(){this._mainView=Main.ins.mainView,this._gameView=this._mainView.getView(GameView)},e.prototype.update=function(){if(this._createdNextBox){var e=egret.getTimer();this._interval++,this.removeBox();var t=!1;this._moveState==GameConst.UP&&(t=this.transformation(),this._moveState=GameConst.DOWN),GameModel.ins().horizontalOffIndex>0?(this.checkMove(1,0)&&(this.pointBox.x+=1,SoundMgr.ins().playSoundEffect(SoundMgr.RES_MOVE_RIGHT),t=!0),GameModel.ins().horizontalOffIndex--):GameModel.ins().horizontalOffIndex<0&&(this.checkMove(-1,0)&&(this.pointBox.x-=1,SoundMgr.ins().playSoundEffect(SoundMgr.RES_MOVE_LEFT),t=!0),GameModel.ins().horizontalOffIndex++);var i=!1;if(t&&(this._optionTime=e),this._interval>=GameModel.ins().getDownInterval()&&GuideMgr.ins().checkCanDown()||this._directlyDowning)if(this._interval=0,this.checkMove(0,1))this.pointBox.y++;else if(this._isBoxDowned||(this._optionTime=this._lastBoxMoveDownTime=e,this._isBoxDowned=!0),this._directlyDowning||e-this._optionTime>650||e-this._lastBoxMoveDownTime>4e3){if(this.pushBox(),this._gameView.drawMap(),i=!0,this.setBoxStaus(BoxItemStaus.IN_MAP),this.pointBox.y<0)return void this.showGameOver(3);this.checkEliminate(),this.nextBox(),SoundMgr.ins().playSoundEffect(SoundMgr.RES_V_DOWN)}this.pushBox(),this._gameView.drawMap()}},e.prototype.resetGame=function(){SoundMgr.ins().resetData(),this.clearMap(),this._isGameOver=!1,this._isGamePause=!0,GameModel.ins().resetData(),this._gameView.init(),this.nextBox(),GuideMgr.ins().hasGuide()?this._mainView.getView(GuideView).show():(GameModel.ins().startGameTime(),MarkDataUtil.markGameActionData(MarkEventId.BEGIN_GAME,{desc:"tetris begin game"},!0))},e.prototype.clearMap=function(){BoxModel.ins().init(),this.nextBoxInfo=[],this.nowBoxInfo=[],this.holdBoxInfo=[],this._mapInfo=[];for(var e=0;e<GameConst.MAP_ROW;e++){this._mapInfo[e]=[];for(var t=0;t<GameConst.MAP_COL;t++)this._mapInfo[e][t]=0}var i=[];if(i=GuideMgr.ins().hasGuide()?GuideMgr.ins().getCurMapInfo():BoxModel.ins().getInitMessBoxInfo(),i.length>0)for(var e=0;e<i.length;e++)for(var t=0;t<i[e].length;t++){var o=i[e][t],n=this._mapInfo.length-i.length+e;this._mapInfo[n][t]=o;var s=BoxModel.ins().getBoxItemByUuid(o);s&&(s.setRowAndCol(n,t),s.status=BoxItemStaus.IN_MAP)}this._createdNextBox=!0,this._directlyDowning=!1,this._isBoxDowned=!1},e.prototype.moveBy=function(e,t){this.removeBox(),this.pointBox.x+=e,this.pointBox.y+=t,this.pushBox()},e.prototype.pushBox=function(){for(var e=0;this.checkMove(0,e);)e++;e>0&&e--;for(var t=this._nowBoxInfo.length,i=0;t>i;i++)for(var o=0;o<this._nowBoxInfo[i].length;o++){var n=i+this.pointBox.y,s=o+this.pointBox.x;if(this._nowBoxInfo[i][o]>0&&this._mapInfo[n]&&void 0!=this._mapInfo[s][s]){var a=n+e;this._mapInfo[a][s]=-1;var r=this._nowBoxInfo[i][o];if(this._mapInfo[n][s]=r,r>0){var h=BoxModel.ins().getBoxItemByUuid(r);h&&h.setRowAndCol(n,s)}}}},e.prototype.removeBox=function(){for(var e=this._nowBoxInfo.length,t=0;e>t;t++)for(var i=0;i<this._nowBoxInfo[t].length;i++){var o=t+this.pointBox.y,n=i+this.pointBox.x;this._nowBoxInfo[t][i]>0&&this._mapInfo[o]&&void 0!=this._mapInfo[n][n]&&(this._mapInfo[o][n]=0)}for(var t=0;t<this._mapInfo.length;t++)for(var i=0;i<this._mapInfo[t].length;i++)this._mapInfo[t][i]<0&&(this._mapInfo[t][i]=0)},e.prototype.checkMove=function(e,t,i,o){void 0===i&&(i=this.pointBox),void 0===o&&(o=this._nowBoxInfo);var n,s;for(n=0;n<o.length;n++)for(s=0;s<o[n].length;s++){var a=o[n][s];if(a>0){var r=s+i.x+e,h=n+i.y+t;if(r>GameConst.MAP_COL||h>GameConst.MAP_ROW)return!1;if(0>h&&0==e)continue;if(!this._mapInfo[h]||void 0==this._mapInfo[h][r]||0!=this._mapInfo[h][r])return!1}}return o.length>0},e.prototype.nextBox=function(e){if(void 0===e&&(e=[]),this._createdNextBox){this._createdNextBox=!1,GameModel.ins().verticalOffIndex=1,0==this.nextBoxInfo.length&&(this.nextBoxInfo=BoxModel.ins().getBoxInfo());for(var t=e.length>0?e:this.nextBoxInfo,i=new egret.Point(GameConst.BOX_INIT_X-Math.floor(t[0].length/2),GameConst.BOX_INIT_Y);!this.checkMove(0,0,i,t);)i.y--;if(0==e.length&&this.nowBoxInfo.length>0)for(var o=0,n=this.nowBoxInfo;o<n.length;o++){for(var s=n[o],a=!1,r=0,h=s;r<h.length;r++){var l=h[r],_=BoxModel.ins().getBoxItemByUuid(l);if(_){GameModel.ins().totalScore+=GameConst.BOX_COLOR_LANDED_SCORE[_.color]||0,a=!0;break}}if(a)break}this.nowBoxInfo=t,this.setBoxStaus(BoxItemStaus.MOVING),0==e.length&&(this.nextBoxInfo=BoxModel.ins().getBoxInfo()),this.pointBox.x=i.x,this.pointBox.y=i.y,this._directlyDowning=!1,this._isBoxDowned=!1,BoxModel.ins().drawBoxesWhiteEdge()}this._createdNextBox=!0},e.prototype.setBoxStaus=function(e,t){void 0===t&&(t=this.nowBoxInfo);for(var i=0,o=t;i<o.length;i++)for(var n=o[i],s=0,a=n;s<a.length;s++){var r=a[s],h=BoxModel.ins().getBoxItemByUuid(r);h&&(h.status=e)}},e.prototype.checkEliminate=function(){for(var t=0,i=this._nowBoxInfo.length,o=0,n=0,s=0,a=0,r=0;i>r;r++){for(var h=0,l=r+this.pointBox.y,_=0,u=0;u<this._nowBoxInfo[r].length;u++)this._nowBoxInfo[r][u]>0&&(_=u);if(_+=this.pointBox.x,l>=this._mapInfo.length)break;for(var c=!1,u=0;u<this._mapInfo[l].length;u++)if(this._mapInfo[l][u]>0){var d=BoxModel.ins().getBoxItemByUuid(this._mapInfo[l][u]);if(d&&d.color==GameConst.MESS_BOX_COLOR&&(c=!0),h++,h>=this._mapInfo[l].length){var m=!0;c&&(a++,GameModel.ins().gameRemindMessNum>0&&(s++,m=!1),GameModel.ins().gameRemindMessNum--),this.eliminateLine(l,m),o=l,n=_,t++}}}if(t>0){SoundMgr.ins().playSoundEffect(SoundMgr.RES_ELIMINATE);var p=GameConst.GAME_LEVEL_SCORE_Multiple[GameModel.ins().gameLevel]||GameConst.GAME_LEVEL_SCORE_Multiple[GameConst.GAME_LEVEL_SCORE_Multiple.length-1];BoxModel.ins().drawBoxesWhiteEdge();var g=GameConst.ONE_TIME_ELIMINATION_SCORE[t]||GameConst.ONE_TIME_ELIMINATION_SCORE[GameConst.ONE_TIME_ELIMINATION_SCORE.length-1];g=p*g;var f="+"+g;this._gameView.playScoreAddEffect(f,o,n),GameModel.ins().totalEliminateLines+=t,GameModel.ins().gameMissNum=0,GameModel.ins().lastEliminateLines=t,GameModel.ins().continuousEliminateLines+=1;var v=GameModel.ins().continuousEliminateLines;if(v>=2){var E=100*p*(v-1);g+=E,f="+"+E,this._gameView.playScoreAddEffect(f,o,n,200)}this.newMessLine(s),a>0&&MarkDataUtil.markGameActionData(MarkEventId.CLEAN_MESS,{desc:"tetris CLEAN_MESS",eliminate_mess:a,game_mess:(GuideMgr.ins().hasGuide()?3:GameConst.initMessLines)+GameModel.ins().gameRemindMessNum},!1),a>0&&!e.ins().isMessBoxInMap()?(g+=GameConst.MESS_CLEAN_SCORE,f="+"+GameConst.MESS_CLEAN_SCORE,this._gameView.playScoreAddEffect(f,o,n,500,!0),this._gameView.playEffect(EffectMgr.RES_EFFECT_CLEAR),SoundMgr.ins().playSoundEffect("clear_mp3")):GameModel.ins().lastEliminateLines>=4&&this._gameView.playEffect(EffectMgr.RES_EFFECT_PERFECT),GameModel.ins().totalScore=GameModel.ins().totalScore+g,MarkDataUtil.markGameActionData(MarkEventId.ELIMINATE,{desc:"tetris ELIMINATE",eliminate_line:t,game_score:GameModel.ins().totalScore},!1)}else GameModel.ins().gameMissNum+=1,GameModel.ins().continuousEliminateLines=0;GuideMgr.ins().checkNextGuide(t)},e.prototype.eliminateLine=function(e,t){this._gameView.playEliminateLineEffect(e);for(var i=e;i>0;i--)for(var o=0;o<this._mapInfo[i].length;o++){i==e&&BoxModel.ins().deleteBoxItemByUuid(this._mapInfo[i][o]);var n=this._mapInfo[i-1][o];if(this._mapInfo[i][o]=n,n>0){var s=BoxModel.ins().getBoxItemByUuid(n);s&&t&&s.setRowAndCol(i,o)}}for(var o=0;o<this._mapInfo.length;o++)this._mapInfo[0][o]=0},e.prototype.transformation=function(){var e=this._nowBoxInfo;this._nowBoxInfo=[];for(var t=(this.pointBox.x,this.pointBox.y,0);t<e.length;t++){this._nowBoxInfo[t]=[];for(var i=0;i<e[t].length;i++)this._nowBoxInfo[t][i]=e[e.length-1-i][t]}var o=!0;if(!this.checkMove(0,0)&&this.pointBox.y>=0&&(this.checkMove(0,-1)?this.pointBox.y--:this.checkMove(-1,0)?this.pointBox.x--:this.checkMove(1,0)?this.pointBox.x++:this.checkMove(-1,-1)?(this.pointBox.x--,this.pointBox.y--):this.checkMove(1,-1)?(this.pointBox.x++,this.pointBox.y--):this._nowBoxInfo.length>3?this.checkMove(0,-2)?this.pointBox.y-=2:this.checkMove(-2,0)?this.pointBox.x-=2:this.checkMove(-2,-1)?(this.pointBox.x-=2,this.pointBox.y--):this.checkMove(-1,-2)?(this.pointBox.x-=1,this.pointBox.y-=2):this.checkMove(1,-2)?(this.pointBox.x+=1,this.pointBox.y-=2):this.checkMove(2,0)?this.pointBox.x+=2:this.checkMove(2,-1)?(this.pointBox.x+=2,this.pointBox.y-=1):this.checkMove(-2,-2)?(this.pointBox.x-=2,this.pointBox.y-=2):this.checkMove(2,-2)?(this.pointBox.x+=2,this.pointBox.y-=2):o=!1:o=!1),o){SoundMgr.ins().playSoundEffect(SoundMgr.RES_TRANSFORMATION);for(var n=[],t=0;t<this._nowBoxInfo.length;t++)for(var i=0;i<this._nowBoxInfo[t].length;i++){var s=this._nowBoxInfo[t][i],a=BoxModel.ins().getBoxItemByUuid(s);a&&(a.setRowAndCol(t+this.pointBox.y,i+this.pointBox.x),n.push(a))}BoxModel.ins().drawOneShapeWhite(n)}else this._nowBoxInfo=e;return o},e.prototype.directlyDown=function(){if(!(this.nowBoxInfo.length<=0)){GameModel.ins().horizontalOffIndex=0,this.removeBox();for(var e=0;this.checkMove(0,e);)e++;e>0&&e--,this.pointBox.y+=e,this.pushBox(),SoundMgr.ins().playSoundEffect(SoundMgr.RES_V_DOWN),SoundMgr.ins().playSoundEffect(SoundMgr.RES_DIRECTLY_DOWN),this._gameView.drawMap(),this.setBoxStaus(BoxItemStaus.IN_MAP);for(var t=0,i=this.nowBoxInfo;t<i.length;t++)for(var o=i[t],n=0,s=o;n<s.length;n++){var a=s[n],r=BoxModel.ins().getBoxItemByUuid(a);r&&r.playDirectDownEffect()}this._directlyDowning=!0}},e.prototype.holdOrSwapBox=function(){GameModel.ins().gameHoldNum++,this.removeBox();var e=this.holdBoxInfo;this.holdBoxInfo=this.nowBoxInfo,this.nextBox(e),GuideMgr.ins().checkNextGuide(0),MarkDataUtil.markGameActionData(MarkEventId.HOLD_BOX,{desc:"tetris HOLD_BOX",hold_num:GameModel.ins().gameHoldNum},!1)},e.prototype.newMessLine=function(e){for(var t=0;t<GameConst.MAP_ROW-e;t++)for(var i=0;i<GameConst.MAP_COL;i++){var o=this._mapInfo[t+e][i];if(this._mapInfo[t][i]=o,o>0){var n=BoxModel.ins().getBoxItemByUuid(o);n&&n.setRowAndCol(t,i)}}for(var s=BoxModel.ins().getNewMessBoxInfo(e),t=0;t<s.length;t++)for(var i=0;i<GameConst.MAP_COL;i++){var o=s[t][i],a=GameConst.MAP_ROW-1-t;this._mapInfo[a][i]=o;var n=BoxModel.ins().getBoxItemByUuid(o);n&&(n.setRowAndCol(a,i),n.y+=500,n.status=BoxItemStaus.IN_MAP,n.setRowAndCol(a,i))}BoxModel.ins().drawBoxesWhiteEdge()},e.prototype.showGameOver=function(e){void 0===e&&(e=1),this._mainView.getView(GameOverView).show(e)},e.prototype.isMessBoxInMap=function(){for(var e=0;e<this._mapInfo.length;e++)for(var t=0;t<this._mapInfo[e].length;t++)if(this._mapInfo[e][t]>0){var i=BoxModel.ins().getBoxItemByUuid(this._mapInfo[e][t]);if(i&&i.color==GameConst.MESS_BOX_COLOR)return!0}return!1},e.prototype.getMapInfoHeight=function(){for(var e=0,t=this.mapInfo,i=t.length,o=0;i>o;o++){for(var n=!1,s=0;s<t[o].length;s++){var a=t[o][s];if(!(0>=a)){var r=BoxModel.ins().getBoxItemByUuid(a);if(r&&r.status==BoxItemStaus.IN_MAP&&r.color>0){n=!0,e=i-o;break}}}if(n)break}return e},Object.defineProperty(e.prototype,"mapInfo",{get:function(){return this._mapInfo},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nextBoxInfo",{get:function(){return this._nextBoxInfo},set:function(e){this._nextBoxInfo=e,this._gameView.drawNextBoxView()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"nowBoxInfo",{get:function(){return this._nowBoxInfo},set:function(e){this._nowBoxInfo=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"holdBoxInfo",{get:function(){return this._holdBoxInfo},set:function(e){for(var t=[],i=0,o=e;i<o.length;i++)for(var n=o[i],s=0,a=n;s<a.length;s++){var r=a[s];r>0&&t.push(r)}if(t.length>0){var h=[],l=BoxModel.ins().getBoxItemByUuid(t[0]),_=BoxModel.boxList[l.color-1];this._holdBoxInfo=[];for(var u=0,c=0;c<_.length;c++){this._holdBoxInfo[c]=[];for(var d=0;d<_[c].length;d++)if(_[c][d]>0){var m=BoxModel.ins().getBoxItemByUuid(t[u]);h.push(m),m.setRowAndCol(c,d),this._holdBoxInfo[c][d]=t[u]||0,u++}else this._holdBoxInfo[c][d]=0}BoxModel.ins().drawOneShapeWhite(h)}else this._holdBoxInfo=e;this._gameView.drawHoldBoxView()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"moveState",{set:function(e){this._moveState=e},enumerable:!0,configurable:!0}),e}();__reflect(GameManager.prototype,"GameManager");var GameWorld=function(){function e(){}return e.getInstance=function(){return e.instance||(e.instance=new e),e.instance},e.prototype.startGame=function(){Main.ins.addEventListener(egret.Event.ENTER_FRAME,this.onEnder,this)},e.prototype.onEnder=function(){GameManager.ins()._isGameOver||GameManager.ins()._isGamePause||(GameManager.ins().update(),Main.ins.mainView.getView(GameView).update())},e}();__reflect(GameWorld.prototype,"GameWorld");var MainView=function(e){function t(){var t=e.call(this)||this;return t._views={},t.skinName="MainViewSkin",t}return __extends(t,e),t.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},t.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.percentWidth=this.percentHeight=100;for(var t=[{view:GameView,show:!0,parent:this.layer_base},{view:GameOverView,show:!1,parent:this.layer_base},{view:GMView,show:!1,parent:this.layer_base},{view:PauseView,show:!1,parent:this.layer_base},{view:GuideView,show:!1,parent:this.layer_base}],i=0,o=t;i<o.length;i++){var n=o[i],s=egret.getQualifiedClassName(n.view);this._views[s]=new n.view,this._views[s].setParent(n.parent),n.show&&this._views[s].show()}},t.prototype.getView=function(e){return"string"==typeof e?this._views[e]:this._views[egret.getQualifiedClassName(e)]},t}(eui.Component);__reflect(MainView.prototype,"MainView",["eui.UIComponent","egret.DisplayObject"]);var LoadingUI=function(e){function t(){var t=e.call(this)||this;return t.skinName="LoadingUISkin",t}return __extends(t,e),t.prototype.onProgress=function(e,t){this.img_progress&&(this.img_progress.width=596*(e/t))},t.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},t.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this),this.lb_version.text="version:"+GameConst.appVersion},t}(eui.Component);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var GuideMgr=function(e){function t(){var t=e.call(this)||this;return t._guideType=0,t._guideStep=0,t._cacheTotalScore=0,t._cacheTotalEliminateLines=0,t._cacheContinuousEliminateLines=0,t._cacheGameRemindMessNum=0,t._initBoxIndex=[3,5,6,1,1,3,4,0,2,3,4,5,6,1,2],t._curBoxIndex=0,t._initMapInfo=[[2,2,0,0,0,1,6,6,6,3],[4,2,2,0,5,1,6,4,4,4],[4,4,3,3,5,1,0,0,7,7],[4,3,3,5,5,1,0,0,7,7],[8,8,8,8,0,0,0,8,8,8],[8,8,8,8,0,8,8,8,8,8],[8,8,0,8,8,8,8,8,8,8]],t}return __extends(t,e),t.ins=function(){return e.ins.call(this)},Object.defineProperty(t.prototype,"guideType",{get:function(){return this._guideType},set:function(e){this._guideType=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"guideStep",{get:function(){return this._guideStep},set:function(e){this._guideStep=e,this._cacheTotalScore=GameModel.ins().totalScore,this._cacheTotalEliminateLines=GameModel.ins().totalEliminateLines,this._cacheContinuousEliminateLines=GameModel.ins().continuousEliminateLines,this._cacheGameRemindMessNum=GameModel.ins().gameRemindMessNum},enumerable:!0,configurable:!0}),t.prototype.init=function(){this.resetData()},t.prototype.resetData=function(){this._curBoxIndex=0,this.guideStep=0},t.prototype.hasGuide=function(){return 0!=this.guideType},t.prototype.getNextBoxIndex=function(){var e=this._initBoxIndex[this._curBoxIndex];return this._curBoxIndex++,e||0},t.prototype.getCurMapInfo=function(){for(var e=[],t=[0,0,0,2,2,4,4,6][this.guideStep]||0,i=t;i<this._initMapInfo.length;i++){e[i-t]=[];for(var o=0;o<GameConst.MAP_COL;o++){var n=this._initMapInfo[i][o];if(n){var s=BoxModel.ins().newBoxItem(n,n);e[i-t][o]=s.uuid}else e[i-t][o]=0}}return e},t.prototype.checkNextGuide=function(e){if(void 0===e&&(e=0),1==this.guideType){var t=[5,5,5,5,3,3,1,2,2][this.guideStep]||0,i=[0,0,2,0,2,0,2,1][this.guideStep]||0;GameManager.ins().getMapInfoHeight()==t&&e==i?this.showNextGuide():this.resetCurGuide()}},t.prototype.resetCurGuide=function(){if(1==this.guideType){switch(this._curBoxIndex=[0,0,0,1,2,3,4,4][this.guideStep]||0,GameManager.ins().clearMap(),this.guideStep){case 4:case 5:GameManager.ins().holdBoxInfo=BoxModel.ins()._getBoxInfo(BoxModel.boxList[5],6);break;case 6:GameManager.ins().nextBoxInfo=BoxModel.ins()._getBoxInfo(BoxModel.boxList[5],6);case 7:GameManager.ins().holdBoxInfo=BoxModel.ins()._getBoxInfo(BoxModel.boxList[1],2)}GameModel.ins().totalScore=this._cacheTotalScore,GameModel.ins().totalEliminateLines=this._cacheTotalEliminateLines,GameModel.ins()._continuousEliminateLines=this._cacheContinuousEliminateLines,GameModel.ins().gameRemindMessNum=this._cacheGameRemindMessNum}},t.prototype.showNextGuide=function(){Main.ins.mainView.getView(GuideView).showNextStep()},t.prototype.checkCanHold=function(){if(1==this.guideType){switch(this.guideStep){case 3:case 5:return!0}return!1}return!0},t.prototype.checkCanDown=function(){if(1==this.guideType){switch(this.guideStep){case 7:return!0}return!1}return!0},t}(SingletonClass);__reflect(GuideMgr.prototype,"GuideMgr");var LocalStorageMgr=function(e){function t(){return e.call(this)||this}return __extends(t,e),t.ins=function(){return e.ins.call(this)},t.prototype.setLocal=function(e,t){egret.localStorage.setItem(e,t)},t.prototype.getLocal=function(e,t){var i=egret.localStorage.getItem(e);if(null==i)return t;switch(typeof t){case"boolean":return"true"==i;case"number":return Number(i)}return i},t.KEY_MUSIC_VOLUME="KEY_MUSIC_VOLUME",t.KEY_SOUND_VOLUME="KEY_SOUND_VOLUME",t.KEY_SHOW_SHADOW_BOXES="KEY_SHOW_SHADOW_BOXES",t.KEY_DIRECTLYDOWN_BTN_POS_IS_LEFT="KEY_DIRECTLYDOWN_BTN_POS_IS_LEFT",t.KEY_bestAllTimeScore="KEY_bestAllTimeScore",t}(SingletonClass);__reflect(LocalStorageMgr.prototype,"LocalStorageMgr");
var RandomSeedType;!function(e){e[e.UNDEFINE=0]="UNDEFINE",e[e.BOX_ITEM=1]="BOX_ITEM",e[e.MESS_LINE=2]="MESS_LINE"}(RandomSeedType||(RandomSeedType={}));var RandomMgr=function(e){function t(){var t=e.call(this)||this;return t._seeds=[],t._seedIndex=[],t._selectedIndexes=[],t}return __extends(t,e),t.ins=function(){return e.ins.call(this)},t.prototype.init=function(){var e=[RandomSeedType.UNDEFINE,RandomSeedType.BOX_ITEM,RandomSeedType.MESS_LINE];this._seeds=[],this._selectedIndexes=[],this._seedIndex=[];for(var t=0,i=e;t<i.length;t++){var o=i[t];this._seeds[o]=[],this._selectedIndexes[o]=[],this._seedIndex[o]=0}for(var n=0;n<GameConst.randomSeed.length;n++){var s=parseInt(GameConst.randomSeed[n],36)||0;s=(9301*s+49297)%1048576||0;for(var a=0,r=e;a<r.length;a++){var o=r[a];this._seeds[o].push(s)}}},t.prototype.getNextBoxIndex=function(){var e=RandomSeedType.BOX_ITEM,t=this.randomNum(0,6,RandomSeedType.BOX_ITEM),i=this._selectedIndexes[e].length;return i>=2&&this._selectedIndexes[e][i-2]==t&&this._selectedIndexes[e][i-1]==t?(this._selectedIndexes[e].pop(),this.getNextBoxIndex()):t},t.prototype.randomNum=function(e,t,i){void 0===i&&(i=RandomSeedType.UNDEFINE),e>t&&(t=e);var o=this._seedIndex[i]%GameConst.randomSeed.length,n=e+this._seeds[i][o]%(t-e+1);return this._seeds[i][o]=(9301*this._seeds[i][o]+49297)%1048576||0,this._seedIndex[i]++,this._selectedIndexes[i].push(n),n},t}(SingletonClass);__reflect(RandomMgr.prototype,"RandomMgr");var SoundMgr=function(e){function t(){var t=e.call(this)||this;return t._isPlayMusic=!1,t._musicVolume=1,t._soundVolume=1,t._soundReses={},t}return __extends(t,e),Object.defineProperty(t.prototype,"musicVolume",{get:function(){return this._musicVolume},set:function(e){this._musicVolume=e,this._isPlayMusic&&(this._bgChannel.volume=e),LocalStorageMgr.ins().setLocal(LocalStorageMgr.KEY_MUSIC_VOLUME,e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"soundVolume",{get:function(){return this._soundVolume},set:function(e){this._soundVolume=e,this._isPlayMusic&&(this._bgChannel.volume=e),LocalStorageMgr.ins().setLocal(LocalStorageMgr.KEY_SOUND_VOLUME,e)},enumerable:!0,configurable:!0}),t.ins=function(){return e.ins.call(this)},t.prototype.init=function(){this._soundReses={};var e=RES.getRes(t.RES_BG);e&&e.play&&(this._bgChannel=e.play(),this._bgChannel.volume=0,this._isPlayMusic=!1),this.soundVolume=LocalStorageMgr.ins().getLocal(LocalStorageMgr.KEY_SOUND_VOLUME,1),this.musicVolume=LocalStorageMgr.ins().getLocal(LocalStorageMgr.KEY_MUSIC_VOLUME,1)},t.prototype.resetData=function(){this.changeBg(t.RES_BG)},t.prototype.playSoundEffect=function(e){this._soundReses[e]||(this._soundReses[e]=RES.getRes(e));var t=this._soundReses[e];if(t&&t.play){var i=t.play(0,1);i.volume=this._soundVolume}},t.prototype.playBg=function(e){void 0===e&&(e=!0),this._isPlayMusic=e,this._bgChannel&&(this._bgChannel.volume=e?this._musicVolume:0)},t.prototype.changeBg=function(e){this._bgChannel&&this._bgChannel.stop();var t=RES.getRes(e);t&&t.play&&(this._bgChannel=t.play(),this._bgChannel.volume=this._isPlayMusic?this._musicVolume:0)},t.RES_MOVE_LEFT="move_left_mp3",t.RES_MOVE_RIGHT="move_right_mp3",t.RES_V_DOWN="v_down_mp3",t.RES_ELIMINATE="eliminate_mp3",t.RES_TRANSFORMATION="transformation_mp3",t.RES_COUNT_DOWN="countdown_mp3",t.RES_DIRECTLY_DOWN="directly_down_mp3",t.RES_HOLD_BOX="hold_box_mp3",t.RES_HOLD_BOX_FAIL="hold_box_fail_mp3",t.RES_TIME_TIPS="time_tips_mp3",t.RES_BG="bg_mp3",t.RES_BG2="bg2_mp3",t}(SingletonClass);__reflect(SoundMgr.prototype,"SoundMgr");var BoxModel=function(e){function t(){var t=e.call(this)||this;return t._uuid=1,t._groupId=1e4,t._allBox={},t._deletedBox=[],t._messBoxesGropId=t.newGroupId(),t.nextBoxInfos=[],t._shadowBoxes=[],t._shadowInGameViewBoxes=[],t}return __extends(t,e),t.ins=function(){return e.ins.call(this)},t.prototype.newUuid=function(){return this._uuid++,this._uuid},t.prototype.newGroupId=function(){return this._groupId++,this._groupId},t.prototype.init=function(){for(var e in this._allBox)this.deleteBoxItemByUuid(Number(e));this._allBox={},this.nextBoxInfos=[],this.nextBoxInfos.push(this._getBoxInfo()),this.nextBoxInfos.push(this._getBoxInfo())},t.prototype.newBoxItem=function(e,t){var i;if(this._deletedBox.length<=0){var o=this.newUuid();i=new BoxItem(o)}else i=this._deletedBox.shift();return i.setColor(e),t&&(i.groupId=t),this._allBox[i.uuid]=i,i},t.prototype._getBoxInfo=function(e,i,o){if(void 0===e&&(e=[]),void 0===i&&(i=8),0==e.length){var n=GuideMgr.ins().hasGuide()?GuideMgr.ins().getNextBoxIndex():RandomMgr.ins().getNextBoxIndex();i=n+1,e=t.boxList[n]}var s=e.length,a=[];o=o?o:this.newGroupId();for(var r=[],h=0;s>h;h++){a[h]=[];for(var l=0;l<e[h].length;l++)if(e[h][l]>0){var _=this.newBoxItem(i);a[h][l]=_.uuid,_.row=h,_.col=l,_.groupId=o,r.push(_)}else a[h][l]=0}return this.drawOneShapeWhite(r),a},t.prototype.getBoxInfo=function(){var e=this.nextBoxInfos.shift();return this.nextBoxInfos.push(this._getBoxInfo()),e},t.prototype.getInitMessBoxInfo=function(){for(var e=[],t=GameConst.initMessLines,i=0;t>i;i++){e[i]=[];for(var o=RandomMgr.ins().randomNum(GameConst.initMessBrokenMinNum,GameConst.initMessBrokenMaxNum,RandomSeedType.MESS_LINE),n=[],s=0;o>s;){var a=RandomMgr.ins().randomNum(0,GameConst.MAP_COL-1,RandomSeedType.MESS_LINE);n.indexOf(a)<0&&(n.push(a),s++)}n.sort(function(e,t){return e-t});for(var r=n.shift(),h=0;h<GameConst.MAP_COL;h++)h==r?(e[i][h]=0,r=n.shift()):e[i][h]=1}return 0==e.length?e:this._getBoxInfo(e,8,this._messBoxesGropId)},t.prototype.getNewMessBoxInfo=function(e){for(var t=[],i=0;e>i;i++){t[i]=[];for(var o=RandomMgr.ins().randomNum(GameConst.newMessBrokenMinNum,GameConst.newMessBrokenMaxNum,RandomSeedType.MESS_LINE),n=[],s=0;o>s;){var a=RandomMgr.ins().randomNum(0,GameConst.MAP_COL-1,RandomSeedType.MESS_LINE);n.indexOf(a)<0&&(n.push(a),s++)}n.sort(function(e,t){return e-t});for(var r=n.shift(),h=0;h<GameConst.MAP_COL;h++)h==r?(t[i][h]=0,r=n.shift()):t[i][h]=1}return 0==t.length?t:this._getBoxInfo(t,8,this._messBoxesGropId)},t.prototype.getBoxItemByUuid=function(e){if(0>e){var t=void 0;return this._shadowBoxes.length>0?t=this._shadowBoxes.shift():(t=new BoxItem(-1),t.setColor(-1),t.status=BoxItemStaus.MOVING),this._shadowInGameViewBoxes.push(t),t}return this._allBox[e]},t.prototype.cleanShdowBoxes=function(){for(var e=0,t=this._shadowInGameViewBoxes;e<t.length;e++){var i=t[e];i.playRemoveEffect(),this._shadowBoxes.push(i)}this._shadowInGameViewBoxes=[]},t.prototype.deleteBoxItemByUuid=function(e){if(this._allBox[e]){var t=this._allBox[e];t.playRemoveEffect(),this._deletedBox.push(t),t.resetData(),delete this._allBox[e]}},t.prototype.drawBoxesWhiteEdge=function(){var e={},t=this._allBox;for(var i in t){var o=t[i];e[o.groupId]||(e[o.groupId]=[]),e[o.groupId].push(o)}for(var n in e){var s=e[n];this.drawOneShapeWhite(s)}},t.prototype.drawOneShapeWhite=function(e){for(var t=0,i=e;t<i.length;t++){var o=i[t];o.img_bian_bot.name=o.img_bian_bot.name=o.img_bian_left.name=o.img_bian_top.name=o.img_bian_right.name="show";for(var n=0,s=e;n<s.length;n++){var a=s[n];o.uuid!=a.uuid&&(o.row==a.row&&(o.col==a.col+1&&(o.img_bian_left.name="hide"),o.col==a.col-1&&(o.img_bian_right.name="hide")),o.col==a.col&&(o.row==a.row+1&&(o.img_bian_top.name="hide"),o.row==a.row-1&&(o.img_bian_bot.name="hide")))}o.drawShapeWhite()}},t.box1=[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],t.box2=[[1,1,0],[0,1,1],[0,0,0]],t.box3=[[0,1,1],[1,1,0],[0,0,0]],t.box4=[[0,1,0],[1,1,1],[0,0,0]],t.box5=[[1,0,0],[1,1,1],[0,0,0]],t.box6=[[0,0,1],[1,1,1],[0,0,0]],t.box7=[[1,1],[1,1]],t.boxList=[t.box1,t.box2,t.box3,t.box4,t.box5,t.box6,t.box7],t}(SingletonClass);__reflect(BoxModel.prototype,"BoxModel");var GameModel=function(e){function t(){var t=e.call(this)||this;return t.horizontalOffIndex=0,t.verticalOffIndex=1,t._totalEliminateLines=0,t._totalScore=0,t._gameTime=0,t._gameTimeIntervalId=0,t._gameLevel=1,t._gameMissNum=0,t._gameRemindMessNum=0,t._lastEliminateLines=0,t._continuousEliminateLines=0,t._showShadowBoxes=!0,t._directlyBtnPosIsLeft=!0,t._gameHoldNum=0,t}return __extends(t,e),t.ins=function(){return e.ins.call(this)},Object.defineProperty(t.prototype,"totalScore",{get:function(){return this._totalScore},set:function(e){this._totalScore=e,Main.ins.mainView.getView(GameView).updateScore(),MarkDataUtil._gameScore=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showShadowBoxes",{get:function(){return this._showShadowBoxes},set:function(e){this._showShadowBoxes=e,LocalStorageMgr.ins().setLocal(LocalStorageMgr.KEY_SHOW_SHADOW_BOXES,e),Main.ins.mainView.getView(GameView).drawMap()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"directlyBtnPosIsLeft",{get:function(){return this._directlyBtnPosIsLeft},set:function(e){this._directlyBtnPosIsLeft=e,LocalStorageMgr.ins().setLocal(LocalStorageMgr.KEY_DIRECTLYDOWN_BTN_POS_IS_LEFT,e),Main.ins.mainView.getView(GameView).updateBtnDirectlyPos()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"gameLevel",{get:function(){return this._gameLevel},set:function(e){var t=this._gameLevel;this._gameLevel=e,e>t&&(MarkDataUtil.markGameActionData(MarkEventId.LEVEL_UP,{desc:"tetris LEVEL_UP",level:e},!1),SoundMgr.ins().playSoundEffect("level_up2_mp3"),8==e&&SoundMgr.ins().changeBg(SoundMgr.RES_BG2)),Main.ins.mainView.getView(GameView).updateLevel(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"gameMissNum",{get:function(){return this._gameMissNum},set:function(e){this._gameMissNum=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"gameHoldNum",{get:function(){return this._gameHoldNum},set:function(e){this._gameHoldNum=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"gameRemindMessNum",{get:function(){return this._gameRemindMessNum},set:function(e){this._gameRemindMessNum;this._gameRemindMessNum=e,Main.ins.mainView.getView(GameView).updateRemindMessNumView()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"gameTime",{get:function(){return this._gameTime},set:function(e){var t=this._gameTime;this._gameTime=e,Main.ins.mainView.getView(GameView).updateTime(t),MarkDataUtil._gameTime=e},enumerable:!0,configurable:!0}),t.prototype.startGameTime=function(){var e=this;this._gameTimeIntervalId||(this._gameTimeIntervalId=egret.setInterval(function(){GameManager.ins()._isGamePause||e.gameTime--,e._gameTime<=0&&GameManager.ins().showGameOver(2)},this,1e3))},t.prototype.stopGameTime=function(){this._gameTimeIntervalId&&(egret.clearInterval(this._gameTimeIntervalId),this._gameTimeIntervalId=0)},Object.defineProperty(t.prototype,"totalEliminateLines",{get:function(){return this._totalEliminateLines},set:function(e){this._totalEliminateLines=e,Main.ins.mainView.getView(GameView).updatetotalEliminateLines();for(var t=0,i=0;i<GameConst.totalEliminateLines_2_gameLevel.length;i++)e>=GameConst.totalEliminateLines_2_gameLevel[i]&&(t=i+1);this.gameLevel!=t&&(this.gameLevel=t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lastEliminateLines",{get:function(){return this._lastEliminateLines},set:function(e){this._lastEliminateLines;this._lastEliminateLines=e,Main.ins.mainView.getView(GameView).updateLastEliminateLinesBuff(),e>=4&&SoundMgr.ins().playSoundEffect("tetris_mp3")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"continuousEliminateLines",{get:function(){return this._continuousEliminateLines},set:function(e){var t=this._continuousEliminateLines;this._continuousEliminateLines=e,e>t&&(Main.ins.mainView.getView(GameView).updateContinuousEliminateLinesBuff(t),e>=2&&(SoundMgr.ins().playSoundEffect("continuousEliminate_mp3"),MarkDataUtil.markGameActionData(MarkEventId.COMBO,{desc:"tetris COMBO",num:e-1},!1)))},enumerable:!0,configurable:!0}),t.prototype.init=function(){this.showShadowBoxes=LocalStorageMgr.ins().getLocal(LocalStorageMgr.KEY_SHOW_SHADOW_BOXES,!0),this.directlyBtnPosIsLeft=LocalStorageMgr.ins().getLocal(LocalStorageMgr.KEY_DIRECTLYDOWN_BTN_POS_IS_LEFT,!0)},t.prototype.resetData=function(){this.gameHoldNum=0,this.horizontalOffIndex=0,this.verticalOffIndex=0,this.totalEliminateLines=0,this.lastEliminateLines=0,this.continuousEliminateLines=0,this.totalScore=0,this.gameMissNum=0,this.gameTime=GameConst.gameTotalTime,this.gameRemindMessNum=GuideMgr.ins().hasGuide()?0:GameConst.initRemindMessLines},t.prototype.getDownInterval=function(){var e=GameConst.V_MOVE_INIT_INTERVAL/(GameConst.GAME_LEVEL_SPEED[this._gameLevel]||GameConst.GAME_LEVEL_SPEED[GameConst.GAME_LEVEL_SPEED.length-1]);return e/this.verticalOffIndex},t}(SingletonClass);__reflect(GameModel.prototype,"GameModel");var GameOverView=function(e){function t(){var t=e.call(this)||this;return t.skinName="GameOverViewSkin",t}return __extends(t,e),t.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},t.prototype.childrenCreated=function(){var t=this;e.prototype.childrenCreated.call(this),this.addTouchTapEvent(this.btn_submit,function(){t.submitScore()}),this._mask_btn_submit=new eui.Image("gameTexture_json.btn_submit_mask"),this.btn_submit.addChild(this._mask_btn_submit),this._mask_btn_submit.percentWidth=this._mask_btn_submit.percentHeight=100,this._mask_btn_submit,this._mask_btn_submit.fillMode=egret.BitmapFillMode.CLIP},t.prototype.submitScore=function(){egret.Tween.removeTweens(this._mask_btn_submit),this.hide(),SoundMgr.ins().playSoundEffect(SoundMgr.RES_V_DOWN),MarkDataUtil.markGameActionData(MarkEventId.SUBMIT_SCORE,{desc:"tetris SUBMIT_SCORE",game_score:GameModel.ins().totalScore,game_time:GameModel.ins().gameTime,game_mess:GameConst.initMessLines+GameModel.ins().gameRemindMessNum},!0),isSdk?Bigbear.end_match(GameModel.ins().totalScore):(GuideMgr.ins().guideType=1,GameManager.ins().resetGame())},t.prototype.show=function(t){var i=this;void 0===t&&(t=1),e.prototype.show.call(this),MarkDataUtil.markGameActionData(MarkEventId.END_GAME,{desc:"tetris END_GAME",end_type:t},!0),egret.Tween.removeTweens(this._mask_btn_submit),this._mask_btn_submit.percentWidth=100,egret.Tween.get(this._mask_btn_submit).wait(3e3).to({percentWidth:0},5e3).call(function(){i.submitScore()}),MarkDataUtil.markGameDateByHeart(!1),GameManager.ins()._isGameOver=!0,GameModel.ins().stopGameTime(),SoundMgr.ins().playBg(!1);var o=GameModel.ins().totalScore;this.lb_sore.text=""+o,o>GameConst.bestTodayScore?(this.lb_today_new.visible=!0,this.lb_best_today.style=this.lb_best_today_num.style="green",GameConst.bestTodayScore=o):(this.lb_today_new.visible=!1,this.lb_best_today.style=this.lb_best_today_num.style="white"),this.lb_best_today_num.text=""+GameConst.bestTodayScore,o>GameConst.bestAllTimeScore?(this.lb_all_time_new.visible=!0,this.lb_best_all_time.style=this.lb_best_all_time_num.style="green",GameConst.bestAllTimeScore=o):(this.lb_all_time_new.visible=!1,this.lb_best_all_time.style=this.lb_best_all_time_num.style="white"),this.lb_best_all_time_num.text=""+GameConst.bestAllTimeScore},t}(BaseView);__reflect(GameOverView.prototype,"GameOverView");var GameView=function(e){function t(){var t=e.call(this)||this;return t._touchBeginPos=new egret.Point,t._touchMovePos=new egret.Point,t._lastTouchMovePos=new egret.Point,t._hasMoved=!1,t._newBox=!1,t._hasSwapHoldBox=!1,t._touchBeginTime=egret.getTimer(),t._resumeInterValId=0,t._scoreInterValId=0,t._scoreNum=0,t._hasFirstHold=!1,t._continuousEliminateLinesBuffGp=[],t._textTipsGps=[],t._textTipsIntervalId=0,t.skinName="GameViewSkin",t}return __extends(t,e),t.prototype.childrenCreated=function(){var t=this;e.prototype.childrenCreated.call(this),this._needShowEffect=!1,this.tweenGroup.play(),this.pb_level.labelDisplay.visible=this.pb_mess.labelDisplay.visible=!1,this.pb_level.maximum=GameConst.totalEliminateLines_2_gameLevel.length,this.gp_map_bg.mask=new egret.Rectangle(0,.75*GameConst.BOX_HEIGHT,GameConst.BOX_WIDTH*GameConst.MAP_COL,GameConst.BOX_HEIGHT*GameConst.MAP_ROW-.75*GameConst.BOX_HEIGHT),this.lb_total_count.visible=this.img_gm.visible=this.lb_lianxiao.visible=this.lb_4qing.visible=!1,this.lb_verison.visible=!isSdk,this.gp_touch.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouchTap,this),this.gp_touch.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMove,this),this.gp_touch.addEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEnd,this),this.gp_touch.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,this.onTouchEnd,this),this.gp_touch.addEventListener(egret.TouchEvent.TOUCH_CANCEL,this.onTouchCancel,this),this.gp_touch.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBegin,this),this.lb_verison.text="version: "+GameConst.appVersion,this.addTouchTapEvent(this.img_gm,function(){Main.ins.mainView.getView(GMView).show()}),this.addTouchTapEvent(this.btn_pause,function(){t.pauseGame()}),this.addTouchTapEvent(this.btn_direclydown,function(){GameManager.ins()._isGameOver||GameManager.ins()._isGamePause||GameManager.ins().directlyDown()}),this.addTouchTapEvent(this.gp_hold_btn,function(){t.swapHoldBox()})},t.prototype.init=function(){this._firstHoldMc&&func.removeFromParent(this._firstHoldMc),this._touchBeginPos=new egret.Point,this._touchMovePos=new egret.Point,this._lastTouchMovePos=new egret.Point,this._hasMoved=!1,this._newBox=!1,this._hasSwapHoldBox=!1,this._hasFirstHold=!1,this.resumeGame(),this.updateGuideView(),this._scoreNum=GameModel.ins().totalScore,this.lb_score.text=""+this._scoreNum},t.prototype.drawMap=function(){BoxModel.ins().cleanShdowBoxes();for(var e=GameManager.ins().mapInfo,t=e.length,i=0;t>i;i++)for(var o=0;o<e[i].length;o++){var n=e[i][o];if(0!=n&&(!(0>n)||GameModel.ins().showShadowBoxes)){var s=BoxModel.ins().getBoxItemByUuid(n);s&&(0>n&&s.setRowAndCol(i,o),s.parent!=this.gp_map&&s.status!=BoxItemStaus.READY&&s.addParent(this.gp_map))}}BoxModel.ins().drawOneShapeWhite(BoxModel.ins()._shadowInGameViewBoxes)},t.prototype.drawNextBoxView=function(){this._newBox=!0,this._hasSwapHoldBox=!1,this.drawBoxView(this.gp_next,GameManager.ins().nextBoxInfo,this.img_next_di),this.drawBoxView(this.gp_next0,BoxModel.ins().nextBoxInfos[0]),this.drawBoxView(this.gp_next1,BoxModel.ins().nextBoxInfos[1])},t.prototype.drawHoldBoxView=function(){this.drawBoxView(this.gp_hold,GameManager.ins().holdBoxInfo,this.img_hold_di)},t.prototype.drawBoxView=function(e,t,i){if(e.removeChildren(),t){for(var o=t.length,n=0,s=0;o>s;s++)for(var a=0;a<t[s].length;a++){var r=t[s][a];if(0!=r){var h=BoxModel.ins().getBoxItemByUuid(r);h&&(n=h.color,h.x=h.width*(a-.5*o)+.5*e.width,h.y=h.height*(s-.5*o)+.5*e.height,h.addParent(e))}}i&&(i.source=n>=0?"boxTexture_json.box_di"+n:"")}},t.prototype.swapHoldBox=function(){if(!this._hasSwapHoldBox&&GuideMgr.ins().checkCanHold()){if(this._hasSwapHoldBox=!0,0==this._hasFirstHold&&(this._hasFirstHold=!0,this._firstHoldMc&&func.removeFromParent(this._firstHoldMc)),GuideMgr.ins().hasGuide()){for(var e=GameManager.ins().nowBoxInfo,t=function(t){for(var i=function(i){var o=e[t][i];if(0==o)return"continue";var n=BoxModel.ins().getBoxItemByUuid(o);n&&(n.status=BoxItemStaus.IN_MAP,n.setRowAndCol(1+t,-.1+i,200,function(){n.row=t,n.col=i,GameManager.ins().nowBoxInfo=e,GameManager.ins().holdOrSwapBox()}))},o=0;o<e[t].length;o++)i(o)},i=0;i<e.length;i++)t(i);GameManager.ins().nowBoxInfo=[]}else GameManager.ins().holdOrSwapBox();SoundMgr.ins().playSoundEffect(SoundMgr.RES_HOLD_BOX),egret.Tween.removeTweens(this.img_hold_light),this.img_hold_light.alpha=0,egret.Tween.get(this.img_hold_light).to({alpha:1},200).to({alpha:0},200)}else SoundMgr.ins().playSoundEffect(SoundMgr.RES_HOLD_BOX_FAIL)},t.prototype.updateScore=function(){},t.prototype.updateLevel=function(e){var t=this,i=GameModel.ins().gameLevel;this.lb_level.text=""+i,this.pb_level.value=i,i>e&&(8==i&&(this.gp_bouns_time.visible=!0,egret.Tween.removeTweens(this.img_bonus_time),this.img_bonus_time.alpha=this.img_bonus_time.scaleX=this.img_bonus_time.scaleY=1,egret.Tween.get(this.img_bonus_time).to({scaleX:1.5,scaleY:1.5},500).wait(500).to({alpha:0},200).call(function(){t.gp_bouns_time.visible=!1})),this.playTextTipsEffect(this.gp_tips_level_up)),this.img_game_light.visible=i>=8},t.prototype.updateMiss=function(){},t.prototype.updateRemindMessNumView=function(){this.pb_mess.maximum=GuideMgr.ins().hasGuide()?3:GameConst.initMessLines+GameConst.initRemindMessLines;var e=GameModel.ins().gameRemindMessNum,t=(GuideMgr.ins().hasGuide()?3:GameConst.initMessLines)+e;this.pb_mess.value=t,this.lb_mess.text=""+t},t.prototype.updateContinuousEliminateLinesBuff=function(e){var t=this,i=GameModel.ins().continuousEliminateLines;if(this.lb_lianxiao.text="连消 "+i,i>=2&&i>e){for(var o=this.gp_map_bg.y+this.gp_map_bg.height*this.gp_map_bg.scaleY-2*GameConst.BOX_HEIGHT,n=GameManager.ins().mapInfo,s=n.length,a=0;s>a;a++){for(var r=!1,h=3;7>h;h++){var l=n[a][h];if(!(0>=l)){var _=BoxModel.ins().getBoxItemByUuid(l);if(_&&_.status==BoxItemStaus.IN_MAP&&_.color>0){r=!0,o=_.y*this.gp_map_bg.scaleY+this.gp_map_bg.y-2*GameConst.BOX_HEIGHT;break}}}if(r)break}var u;if(this._continuousEliminateLinesBuffGp.length<=0){u=new eui.Group,u.width=400,u.height=100,u.anchorOffsetY=100,u.touchEnabled=!1;var c=new eui.Image("gameTexture_json.text_COMBO");u.addChild(c);var d=new eui.Label("+"+(i-1));d.x=295,d.name="lb_combo",d.size=80,u.horizontalCenter=0,u.addChild(d)}else u=this._continuousEliminateLinesBuffGp.shift();var m=u.getChildByName("lb_combo");m.text="+"+(i-1),u.y=o,u.scaleX=u.scaleY=.75,u.alpha=1,this.addChild(u),egret.Tween.get(u).to({y:o-75},800,egret.Ease.circOut).to({scaleX:1,scaleY:1,alpha:0},300).call(function(){func.removeFromParent(u),t._continuousEliminateLinesBuffGp.push(u)})}},t.prototype.updateLastEliminateLinesBuff=function(){var e=GameModel.ins().lastEliminateLines>=4;this.lb_4qing.text=e?"4清buff!":"",e&&this.playTextTipsEffect(this.gp_tips_teris)},t.prototype.updatetotalEliminateLines=function(){var e=GameModel.ins().totalEliminateLines;this.lb_total_count.text="总共消除"+e},t.prototype.updateTime=function(e){var t=this,i=GameModel.ins().gameTime,o=Math.floor(i/60),n=i%60,s=10>n?"0"+n:""+n;this.lb_time.text=o+":"+s,this.lb_time.style=i>30?"white":"red",10>=i&&(SoundMgr.ins().playSoundEffect(SoundMgr.RES_COUNT_DOWN),egret.Tween.get(this.lb_time).to({scaleX:1.5,scaleY:1.5},800).call(function(){t.lb_time.scaleX=t.lb_time.scaleY=1})),i==GameConst.gameTotalTime-60&&GameConst.isFirstGame&&0==this._hasFirstHold&&(this._firstHoldMc||(this._firstHoldMc=EffectMgr.ins().newMovieClip(EffectMgr.RES_EFFECT_CLICK),this._firstHoldMc.x=this.gp_hold_all.width/2,this._firstHoldMc.y=this.gp_hold_all.height,this._firstHoldMc.play(-1)),this.gp_hold_all.addChild(this._firstHoldMc)),this.checkGameLeftEffect()},t.prototype.updateBtnDirectlyPos=function(){this.btn_direclydown.horizontalCenter=GameModel.ins().directlyBtnPosIsLeft?-300:300},t.prototype.checkGameLeftEffect=function(){var e=this;if(!GameManager.ins()._isGameOver&&!GameManager.ins()._isGamePause){var t=GameModel.ins().gameTime;switch(t){case 180:case 120:case 60:case 30:SoundMgr.ins().playSoundEffect(SoundMgr.RES_TIME_TIPS),this.img_time_left.source="gameTexture_json.text_time_tip_"+t,egret.Tween.removeTweens(this.img_time_left),this.img_time_left.horizontalCenter=-700,this.img_time_left.visible=!0,egret.Tween.get(this.img_time_left).to({horizontalCenter:30},500,egret.Ease.sineIn).wait(200).to({horizontalCenter:0},500,egret.Ease.sineIn).wait(1300).call(function(){e.img_time_left.visible=!1})}}},t.prototype.updateGuideView=function(){var e=GuideMgr.ins().hasGuide();this.btn_pause.visible=!e},t.prototype.resumeGame=function(){var e=this;if(this._resumeInterValId&&(egret.clearInterval(this._resumeInterValId),this._resumeInterValId=0),GuideMgr.ins().hasGuide()||!GameManager.ins()._isGamePause||GameManager.ins()._isGameOver)this.gp_daojishi.visible=!1,this.gp_hold_all.visible=this.gp_map.visible=this.gp_all_next.visible=!0,GameManager.ins()._isGamePause=!1;else{MarkDataUtil.markGameDateByHeart(!0);var t=3;this.gp_hold_all.visible=this.gp_map.visible=this.gp_all_next.visible=!1,this.gp_daojishi.visible=!0,this.img_daojishi.source="gameTexture_json.text_daojishi_"+t,SoundMgr.ins().playSoundEffect("resume_count"+t+"_mp3"),this._resumeInterValId=egret.setInterval(function(){return t--,0>=t||GameManager.ins()._isGameOver?(e._resumeInterValId&&(egret.clearInterval(e._resumeInterValId),e._resumeInterValId=0),SoundMgr.ins().playBg(!0),GameManager.ins()._isGamePause=!1,e.gp_daojishi.visible=!1,e.gp_hold_all.visible=e.gp_map.visible=e.gp_all_next.visible=!0,void e.checkGameLeftEffect()):(e.img_daojishi.source="gameTexture_json.text_daojishi_"+t,void SoundMgr.ins().playSoundEffect("resume_count"+t+"_mp3"))},this,1e3)}},t.prototype.pauseGame=function(e){void 0===e&&(e=!1),GameManager.ins()._isGameOver||GuideMgr.ins().hasGuide()||(MarkDataUtil.markGameDateByHeart(!1),this._resumeInterValId&&(egret.clearInterval(this._resumeInterValId),this._resumeInterValId=0),this.gp_hold_all.visible=this.gp_map.visible=this.gp_all_next.visible=!1,Main.ins.mainView.getView(PauseView).show(e))},t.prototype.playEliminateLineEffect=function(e){if(!GameConst.NO_BOX_LIGHT_EFFECT){var t=EffectMgr.ins().newMovieClip(EffectMgr.RES_EFFECT_DEL),i=EffectMgr.ins().getMovieClip(EffectMgr.RES_EFFECT_DEL_LIGHT);this.gp_map.addChild(t),t.x=this.gp_map.width/2,t.y=e*GameConst.BOX_HEIGHT+.5*GameConst.BOX_HEIGHT,t.gotoAndPlay(1,1),i.parent||(this.gp_map.addChild(i),i.x=t.x,i.y=t.y,i.gotoAndPlay(1,1))}},t.prototype.playScoreAddEffect=function(e,t,i,o,n){var s=this;void 0===o&&(o=0),void 0===n&&(n=!1);var a=this.gp_map.localToGlobal();a.x+=i*GameConst.BOX_WIDTH,a.y+=t*GameConst.BOX_HEIGHT;var r=new eui.Label(e);r.alpha=.2,r.size=100,r.bold=!0,r.touchEnabled=!1,r.x=a.x,r.y=a.y,r.style="green",r.textAlign="center";var h=this.lb_score.localToGlobal(),l=egret.Tween.get(r).wait(o).call(function(){s.addChild(r)});l=n?l.to({x:this.width/2-300,y:this.height/2,scaleX:2,scaleY:2,alpha:1},500).wait(500).to({x:h.x+this.lb_score.width+30,y:h.y,size:this.lb_score.size,scaleX:1,scaleY:1},1e3,egret.Ease.cubicOut):l.to({x:h.x+this.lb_score.width+30,y:h.y,size:this.lb_score.size,alpha:1},1500,egret.Ease.cubicOut),l=l.to({x:h.x,alpha:.2},500).call(function(){func.removeFromParent(r)})},t.prototype.playTextTipsEffect=function(e){var t=this;if(this._textTipsGps.push(e),!this._textTipsIntervalId){var i=this._textTipsGps.shift();i&&(i.visible=!0,egret.Tween.get(e).wait(1e3).call(function(){i.visible=!1})),this._textTipsIntervalId=egret.setInterval(function(){var i=t._textTipsGps.shift();i?(i.visible=!0,egret.Tween.get(e).wait(1e3).call(function(){i.visible=!1})):(t._textTipsIntervalId&&egret.clearInterval(t._textTipsIntervalId),t._textTipsIntervalId=0)},this,1e3)}},t.prototype.playEffect=function(e){var t=EffectMgr.ins().getMovieClip(e);t.parent||(t.gotoAndPlay(1,1),this.addChild(t),t.scaleX=t.scaleY=1.3,t.x=this.width/2,t.y=this.height/2-100)},t.prototype.onTouchTap=function(e){},t.prototype.onTouchMove=function(e){this._lastTouchMovePos.x=this._touchMovePos.x,this._lastTouchMovePos.y=this._touchMovePos.y,this._touchMovePos.x=e.stageX,this._touchMovePos.y=e.stageY,this.update(),e.updateAfterEvent()},t.prototype.onTouchEnd=function(e){var t=e.stageY-this._touchBeginPos.y,i=egret.getTimer(),o=i-this._touchBeginTime;this.cleanTouchPos(),o<=GameConst.DIRECTLY_DOWN_INTERVAL&&t<=-GameConst.DIRECTLY_DOWN_INTERVAL?this.swapHoldBox():this._hasMoved?(GameModel.ins().verticalOffIndex=1,o<=GameConst.DIRECTLY_DOWN_INTERVAL&&t>=GameConst.DIRECTLY_DOWN_INTERVAL&&GameManager.ins().directlyDown()):GameManager.ins().moveState=GameConst.UP},t.prototype.onTouchCancel=function(e){egret.log("onTouchCancel",e)},t.prototype.onTouchBegin=function(e){this._touchMovePos.x=this._touchBeginPos.x=e.stageX,this._touchMovePos.y=this._touchBeginPos.y=e.stageY,this.touchBeginInit()},t.prototype.touchBeginInit=function(){this._touchBeginTime=egret.getTimer(),this._newBox=!1,this._hasMoved=!1,this.cleanTouchPos()},t.prototype.cleanTouchPos=function(){this._lastTouchMovePos.x=this._touchBeginPos.x=this._touchMovePos.x,this._lastTouchMovePos.y=this._touchBeginPos.y=this._touchMovePos.y},t.prototype.update=function(){this._newBox&&this.touchBeginInit();var e=this._touchMovePos.x-this._touchBeginPos.x,t=(this._touchMovePos.y-this._touchBeginPos.y,e>0?Math.floor(e/GameConst.H_MOVE_A_CELL_PIXELS):Math.ceil(e/GameConst.H_MOVE_A_CELL_PIXELS));if(Math.abs(t)>=1&&Math.abs(func.getPonitSlope(this._touchMovePos,this._lastTouchMovePos))<1)this._hasMoved=!0,GameModel.ins().horizontalOffIndex=t,this._touchBeginPos.x+=t*GameConst.H_MOVE_A_CELL_PIXELS,GameModel.ins().verticalOffIndex=1,this._touchBeginPos.y=this._touchMovePos.y,this._touchBeginTime=egret.getTimer();else{var i=this._touchMovePos.y-this._touchBeginPos.y,o=i>0?Math.floor(i/GameConst.DOWN_MOVE_ACCELERATED_DOWN_PIXELS):Math.ceil(i/GameConst.DOWN_MOVE_ACCELERATED_DOWN_PIXELS);o>1?(this._hasMoved=!0,GameModel.ins().verticalOffIndex=GameConst.ACCELERATED_DOWN_MULTIPLE):this._touchBeginTime=egret.getTimer()}var n=GameModel.ins().totalScore,s=(n-this._scoreNum)/10;0!=s?(this._scoreNum=this._scoreNum+(s>0?Math.ceil(s):Math.floor(s)),this.lb_score.style="green"):this.lb_score.style="white",0==n&&(this._scoreNum=n),this.lb_score.text=""+this._scoreNum},t}(BaseView);__reflect(GameView.prototype,"GameView");var GMView=function(e){function t(){var t=e.call(this)||this;return t._datas=[{desc:"游戏总时间",key:"gameTotalTime",minValue:30,maxValue:6e3},{desc:"残缺清除得分",key:"MESS_CLEAN_SCORE",minValue:0,maxValue:99999999},{desc:"初始生成残局行数",key:"initRemindMessLines",minValue:0,maxValue:100},{desc:"初始残局行数",key:"initMessLines",minValue:0,maxValue:15},{desc:"初始残局最小空格",key:"initMessBrokenMinNum",minValue:1,maxValue:9},{desc:"初始残局最大空格",key:"initMessBrokenMaxNum",minValue:1,maxValue:9},{desc:" 新残局最小空格",key:"newMessBrokenMinNum",minValue:1,maxValue:9},{desc:" 新残局最大空格",key:"newMessBrokenMaxNum",minValue:1,maxValue:9},{desc:"左右滑动多少像素移动一格",key:"H_MOVE_A_CELL_PIXELS",minValue:10,maxValue:750},{desc:"加速下降倍数",key:"ACCELERATED_DOWN_MULTIPLE",minValue:1,maxValue:60},{desc:"下滑动多少像素加速下降",key:"DOWN_MOVE_ACCELERATED_DOWN_PIXELS",minValue:10,maxValue:1e3},{desc:"直接下降需要的像素",key:"DIRECTLY_DOWN_PIXELS",minValue:10,maxValue:1e3},{desc:"直接下降需要的间隔",key:"DIRECTLY_DOWN_INTERVAL",minValue:10,maxValue:1e4},{desc:"初始下移间隔(多少帧下移一次)",key:"V_MOVE_INIT_INTERVAL",minValue:1,maxValue:60},{desc:"初始位置 X",key:"BOX_INIT_X",minValue:2,maxValue:8},{desc:"屏蔽发光特效",key:"NO_BOX_LIGHT_EFFECT",minValue:0,maxValue:1}],t.skinName="GMViewSkin",t}return __extends(t,e),t.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},t.prototype.childrenCreated=function(){var t=this;e.prototype.childrenCreated.call(this),this.addTouchTapEvent(this.lb_reset,function(){GameManager.ins().resetGame(),t.hide()}),this.addTouchTapEvent(this.lb_close,function(){Main.ins.mainView.getView(GameView).resumeGame(),t.hide()})},t.prototype.show=function(){e.prototype.show.call(this),this.gp_list.removeChildren();for(var t=0,i=this._datas;t<i.length;t++){var o=i[t],n=new GMItem;n.setData(o.key,o.desc,o.minValue,o.maxValue),this.gp_list.addChild(n)}GameManager.ins()._isGamePause=!0},t.prototype.hide=function(){e.prototype.hide.call(this)},t}(BaseView);__reflect(GMView.prototype,"GMView");var GuideView=function(e){function t(){return e.call(this)||this}return __extends(t,e),t.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},t.prototype.childrenCreated=function(){var t=this;e.prototype.childrenCreated.call(this),this.touchEnabled=!1,this.addTouchTapEvent(this.btn_skip,function(){t.skipGame()}),this.addTouchTapEvent(this.btn_play,function(){t.skipGame()}),this.addTouchTapEvent(this.btn_start,function(){t.showNextStep(),SoundMgr.ins().playBg(!0)}),this.addTouchTapEvent(this.btn_next,function(){t.showNextStep(),t.hideBgShape()}),this.initBasicGestureView()},t.prototype.initBasicGestureView=function(){var e=EffectMgr.ins().getMovieClip(EffectMgr.RES_EFFECT_CLICK);this.gp_rote_finger.addChild(e),e.x=this.gp_rote_finger.width/2,e.y=this.gp_rote_finger.height/2,e.play(-1);var t=EffectMgr.ins().newMovieClip(EffectMgr.RES_EFFECT_CLICK);
t.play(-1),this.gp_click_hold.addChild(t);var i=EffectMgr.ins().getMovieClip(EffectMgr.RES_EFFECT_GUIDE_DROP);i.scaleX=i.scaleY=1.1,this.gp_show_drop.addChild(i),i.x=this.gp_show_drop.width/2,i.y=this.gp_show_drop.height/2.2,i.play(-1)},t.prototype.skipGame=function(){SoundMgr.ins().playBg(!1),this.btn_skip.visible=this.btn_play.visible=!1,GuideMgr.ins().guideType=0,GuideMgr.ins().resetData(),GameManager.ins().resetGame(),this.hide()},t.prototype.showNextStep=function(){var e=this;GuideMgr.ins().guideStep++,this.viewStack_guideStep.selectedIndex=GuideMgr.ins().guideStep,8==GuideMgr.ins().guideStep&&(this.gp_congratulation.visible=!1,egret.Tween.removeTweens(this.gp_congratulation),egret.Tween.get(this.gp_congratulation).wait(2e3).call(function(){e.showBgShape(),e.gp_congratulation.visible=!0}))},t.prototype.show=function(){e.prototype.show.call(this),this.tweenGroup.play(),this.showBgShape(),this.btn_play.visible=this.btn_skip.visible=!0,this.viewStack_guideStep.selectedIndex=GuideMgr.ins().guideStep},t.prototype.hide=function(){this.tweenGroup.stop(),e.prototype.hide.call(this)},t}(BaseView);__reflect(GuideView.prototype,"GuideView");var PauseView=function(e){function t(){return e.call(this)||this}return __extends(t,e),t.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},t.prototype.childrenCreated=function(){var t=this;e.prototype.childrenCreated.call(this),this.lb_verison.text="version: "+GameConst.appVersion,this.addTouchTapEvent(this.btn_resume,function(){t.hide()}),this.addTouchTapEvent(this.btn_end,function(){GameManager.ins().showGameOver(1),t.hide()}),this.addTouchTapEvent(this.btn_setting_resume,function(){t.hide()}),this.slider_music.addEventListener(eui.UIEvent.CHANGE,function(){SoundMgr.ins().musicVolume=t.slider_music.value/t.slider_music.maximum},this),this.slider_sound.addEventListener(eui.UIEvent.CHANGE,function(){SoundMgr.ins().soundVolume=t.slider_sound.value/t.slider_music.maximum},this),this.checkBox_shadow.addEventListener(eui.UIEvent.CHANGE,function(){GameModel.ins().showShadowBoxes=t.checkBox_shadow.selected},this),this.checkBox_directlydownBtn.addEventListener(eui.UIEvent.CHANGE,function(){GameModel.ins().directlyBtnPosIsLeft=t.checkBox_directlydownBtn.selected},this)},t.prototype.show=function(t){void 0===t&&(t=!1),e.prototype.show.call(this),SoundMgr.ins().playBg(!1),GameManager.ins()._isGamePause=!0,this.gp_setting.visible=this.gp_pause.visible=!1,t?this.gp_pause.visible=!0:(this.gp_setting.visible=!0,this.slider_music.value=this.slider_music.maximum*SoundMgr.ins().musicVolume,this.slider_sound.value=this.slider_sound.maximum*SoundMgr.ins().soundVolume,this.checkBox_shadow.selected=GameModel.ins().showShadowBoxes,this.checkBox_directlydownBtn.selected=GameModel.ins().directlyBtnPosIsLeft)},t.prototype.hide=function(){Main.ins.mainView.getView(GameView).resumeGame(),e.prototype.hide.call(this)},t}(BaseView);__reflect(PauseView.prototype,"PauseView");var BoxItemStaus;!function(e){e[e.READY=0]="READY",e[e.MOVING=1]="MOVING",e[e.IN_MAP=2]="IN_MAP"}(BoxItemStaus||(BoxItemStaus={}));var BoxItem=function(e){function t(t){void 0===t&&(t=0);var i=e.call(this)||this;return i.groupId=0,i.uuid=0,i.color=0,i.row=-999,i.col=-999,i._status=BoxItemStaus.READY,i.uuid=t,i.skinName="BoxItemSkin",i}return __extends(t,e),t.prototype.resetData=function(){egret.Tween.removeTweens(this),this.groupId=0,this.row=-999,this.col=-999,this._status=BoxItemStaus.READY,this.img_color.source="",this._imgDown&&(this._imgDown.source="",func.removeFromParent(this._imgDown)),this._imgLight&&(this._imgLight.source="",func.removeFromParent(this._imgLight)),this._gravityParticleSystem&&(egret.Tween.removeTweens(this._gravityParticleSystem),func.removeFromParent(this._gravityParticleSystem),this._gravityParticleSystem=null),this.img_color.filters=[]},t.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},t.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this)},Object.defineProperty(t.prototype,"status",{get:function(){return this._status},set:function(e){var t=this;if(this._status==BoxItemStaus.MOVING&&e==BoxItemStaus.IN_MAP&&!GameConst.NO_BOX_LIGHT_EFFECT){var i=[1,0,0,0,80,0,1,0,0,80,0,0,1,0,80,0,0,0,1,0],o=new egret.ColorMatrixFilter(i);this.img_color.filters=[o],egret.setTimeout(function(){t.img_color.filters=[]},this,150)}switch(this._status=e,e){case BoxItemStaus.IN_MAP:}},enumerable:!0,configurable:!0}),t.prototype.setColor=function(e){var t=this;this.color=e,this.alpha=this.color>0?1:.2,e=e>0?e:0,RES.getResAsync("boxTexture_json.box"+e).then(function(e){t.img_color.source=e}),this.updateGlowFilter()},t.prototype.updateGlowFilter=function(){},t.prototype.setRowAndCol=function(e,t,i,o){var n=this;void 0===i&&(i=300),this.row=e,this.col=t;var s=this.width*t,a=this.height*e;(this.x!=s||this.y!=a)&&(this.status==BoxItemStaus.IN_MAP?(egret.Tween.removeTweens(this),egret.Tween.get(this,{onChange:function(){n.drawShapeWhite()}}).to({x:s,y:a},i).call(function(){n.drawShapeWhite(),o&&o()})):(this.x=s,this.y=a),this.drawShapeWhite())},t.prototype.playRemoveEffect=function(){func.removeFromParent(this.img_bian_left),func.removeFromParent(this.img_bian_right),func.removeFromParent(this.img_bian_top),func.removeFromParent(this.img_bian_bot),func.removeFromParent(this)},t.prototype.playDirectDownEffect=function(){var e=this;if(1==this.img_bian_top.alpha){if(this._imgDown||(this._imgDown=new eui.Image,this._imgDown.bottom=this.height,this._imgDown.alpha=.5),this._imgDown.source="boxTexture_json.box_down"+this.color,this.addChild(this._imgDown),this._imgLight||(this._imgLight=new eui.Image,this._imgLight.horizontalCenter=this._imgLight.verticalCenter=0),this._imgLight.source="boxTexture_json.box_light_half",this.addChild(this._imgLight),!this._gravityParticleSystem){var t=RES.getRes("boxTexture_json.box_di"+this.color),i=RES.getRes("directly_down_effect_json");this._gravityParticleSystem=new particle.GravityParticleSystem(t,i),this.addChild(this._gravityParticleSystem)}this._gravityParticleSystem.start(500),egret.Tween.removeTweens(this._gravityParticleSystem),this._gravityParticleSystem.visible=!0,egret.Tween.get(this._gravityParticleSystem).wait(200).call(function(){func.removeFromParent(e._imgLight),e._imgLight.source=""}).wait(300).call(function(){func.removeFromParent(e._imgDown),e._imgDown.source=""}).wait(300).call(function(){func.removeFromParent(e._gravityParticleSystem),e._gravityParticleSystem=null})}else this._imgLight||(this._imgLight=new eui.Image,this._imgLight.horizontalCenter=this._imgLight.verticalCenter=0),this._imgLight.source="boxTexture_json.box_light",this.addChild(this._imgLight),egret.Tween.get(this._imgLight).wait(200).call(function(){func.removeFromParent(e._imgLight),e._imgLight.source=""})},t.prototype.drawShapeWhite=function(){var e=1,t=4,i=4,o="show"==this.img_bian_left.name?0:-t,n="show"==this.img_bian_top.name?0:-i,s=("show"==this.img_bian_left.name?0:t)+("show"==this.img_bian_right.name?0:t),a=("show"==this.img_bian_top.name?0:i)+("show"==this.img_bian_bot.name?0:i),r=3;this.dealImageBian(this.img_bian_left,0+e,0+e,r,this.height-2*e,0,n,0,a),this.img_bian_right.alpha="show"==this.img_bian_right.name?1:0,this.dealImageBian(this.img_bian_right,this.width-r-e,0+e,r,this.height-2*e,0,n,0,a),this.dealImageBian(this.img_bian_top,0+e,0+e,this.height-2*e,r,o,0,s,0),this.img_bian_bot.alpha="show"==this.img_bian_bot.name?1:0,this.dealImageBian(this.img_bian_bot,0+e,this.width-r-e,this.height-2*e,r,o,0,s,0)},t.prototype.addParent=function(e){this.color>0?e.addChild(this):e.addChildAt(this,0),this.drawShapeWhite()},t.prototype.dealImageBian=function(e,t,i,o,n,s,a,r,h){return this.parent?void("show"==e.name&&this.color>0?(e.x=this.x+t+s,e.y=this.y+i+a,e.width=o+r,e.height=n+h,this.parent.addChild(e),e.source="boxTexture_json.box_baix"):(this.color>0?e.source="boxTexture_json.box_baix"+this.color:e.source="show"==e.name?"boxTexture_json.box_baix":this.img_color.source,e.x=t,e.y=i,e.width=o,e.height=n,n>o?e.x=e.x-o/2:e.y=e.y-n/2,this.addChild(e))):void func.removeFromParent(e)},t}(eui.Component);__reflect(BoxItem.prototype,"BoxItem",["eui.UIComponent","egret.DisplayObject"]);var GMItem=function(e){function t(){var t=e.call(this)||this;return t._key="",t._value=0,t._minValue=0,t._maxValue=999,t._interValId=0,t.skinName="GMItemSkin",t}return __extends(t,e),t.prototype.partAdded=function(t,i){e.prototype.partAdded.call(this,t,i)},t.prototype.childrenCreated=function(){var t=this;e.prototype.childrenCreated.call(this),this.lb_add.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){t.addValue(1)},this),this.lb_add.addEventListener(egret.TouchEvent.TOUCH_END,function(){t.addValue(0)},this),this.lb_add.addEventListener(egret.TouchEvent.TOUCH_CANCEL,function(){t.addValue(0)},this),this.lb_add.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,function(){t.addValue(0)},this),this.lb_reduce.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){t.addValue(-1)},this),this.lb_reduce.addEventListener(egret.TouchEvent.TOUCH_END,function(){t.addValue(0)},this),this.lb_reduce.addEventListener(egret.TouchEvent.TOUCH_CANCEL,function(){t.addValue(0)},this),this.lb_reduce.addEventListener(egret.TouchEvent.TOUCH_RELEASE_OUTSIDE,function(){t.addValue(0)},this)},t.prototype.addValue=function(e){var t=this;this._interValId&&(egret.clearInterval(this._interValId),this._interValId=0);var i=function(){t._value+=e,t._value<t._minValue&&(t._value=t._minValue),t._value>t._maxValue&&(t._value=t._maxValue),t.lb_value.text=""+t._value,void 0!=GameConst[t._key]&&(GameConst[t._key]=t._value)};this._interValId=egret.setInterval(function(){i()},this,100),i(),0==e&&(egret.clearInterval(this._interValId),this._interValId=0)},t.prototype.setData=function(e,t,i,o){this._key=e,void 0!=GameConst[this._key]&&(this._value=GameConst[this._key]),this.lb_name.text=t+"\n"+e,this._minValue=i,this._maxValue=o,this.addValue(0)},t}(eui.Component);__reflect(GMItem.prototype,"GMItem",["eui.UIComponent","egret.DisplayObject"]);